<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Genome Viewer Demo</title>

    <!-- build:[href] vendor/fontawesome/css/ -->
    <link rel="stylesheet" href="../../bower_components/fontawesome/css/font-awesome.min.css">
    <!-- /build -->

    <!-- build:[href] vendor/qtip2/ -->
    <link rel="stylesheet" href="../../bower_components/qtip2/jquery.qtip.min.css">
    <!-- /build -->

    <!-- build:[href] styles/css/ -->
    <link rel="stylesheet" href="../../styles/css/style.css">
    <!-- /build -->


    <!-- build:[src] vendor/underscore/ -->
    <script type="text/javascript" src="../../bower_components/underscore/underscore-min.js"></script>
    <!-- /build -->

    <!-- build:[src] vendor/backbone/ -->
    <script type="text/javascript" src="../../bower_components/backbone/backbone.js"></script>
    <!-- /build -->

    <!-- build:[src] vendor/jquery/dist/ -->
    <script type="text/javascript" src="../../bower_components/jquery/dist/jquery.min.js"></script>
    <!-- /build -->

    <!-- build:[src] vendor/qtip2/ -->
    <script type="text/javascript" src="../../bower_components/qtip2/jquery.qtip.min.js"></script>
    <!-- /build -->

    <!-- build:[src] vendor/uri.js/src/ -->
    <script type="text/javascript" src="../../bower_components/uri.js/src/URI.min.js"></script>
    <!-- /build -->

    <!-- build:[src] vendor/cookies.js/src/ -->
    <script type="text/javascript" src="../../bower_components/cookies-js/src/cookies.js"></script>
    <!-- /build -->

    <!-- build:[src] vendor/crypto.js/src/ -->
    <script type="text/javascript" src="../../bower_components/crypto-js-evanvosberg/crypto-js.js"></script>
    <!-- /build -->


    <script type="text/javascript" src="gv-config.js"></script>

    <!-- build:js genome-viewer.min.js -->
    <script type="text/javascript" src="../lib/svg.js"></script>
    <script type="text/javascript" src="../lib/utils.js"></script>
    <script type="text/javascript" src="../lib/region.js"></script>
    <script type="text/javascript" src="../lib/feature-binary-search-tree.js"></script>
    <!--<script type="text/javascript" src="../lib/cellbase-manager.js"></script>-->
    <script type="text/javascript" src="../lib/ensembl-manager.js"></script>
    <!--<script type="text/javascript" src="../lib/opencga-manager.js"></script>-->

    <script type="text/javascript" src="../lib/cache/file-feature-cache.js"></script>
    <script type="text/javascript" src="../lib/cache/feature-chunk-cache.js"></script>
    <script type="text/javascript" src="../lib/cache/memory-store.js"></script>
    <script type="text/javascript" src="../lib/cache/indexedDB-store.js"></script>
    <script type="text/javascript" src="../lib/cache/bam-cache.js"></script>


    <script type="text/javascript" src="../lib/data-adapter/feature/ensembl-adapter.js"></script>
    <!--<script type="text/javascript" src="../lib/data-adapter/feature/opencga-adapter.js"></script>-->
    <script type="text/javascript" src="../lib/data-adapter/feature/feature-template-adapter.js"></script>

    <!--**-->
    <script type="text/javascript" src="../lib/data-adapter/feature/feature-data-adapter.js"></script>
    <script type="text/javascript" src="../lib/data-adapter/feature/vcf-data-adapter.js"></script>
    <script type="text/javascript" src="../lib/data-adapter/feature/gff2-data-adapter.js"></script>
    <script type="text/javascript" src="../lib/data-adapter/feature/gff3-data-adapter.js"></script>
    <script type="text/javascript" src="../lib/data-adapter/feature/bed-data-adapter.js"></script>

    <script type="text/javascript" src="../lib/data-source/data-source.js"></script>
    <script type="text/javascript" src="../lib/data-source/string-data-source.js"></script>
    <script type="text/javascript" src="../lib/data-source/file-data-source.js"></script>
    <!--**-->

    <script type="text/javascript" src="../lib/widgets/feature/info/info-widget.js"></script>
    <script type="text/javascript" src="../lib/widgets/feature/info/gene-info-widget.js"></script>
    <script type="text/javascript" src="../lib/widgets/feature/info/protein-info-widget.js"></script>
    <script type="text/javascript" src="../lib/widgets/feature/info/snp-info-widget.js"></script>
    <script type="text/javascript" src="../lib/widgets/feature/info/transcript-info-widget.js"></script>
    <script type="text/javascript" src="../lib/widgets/feature/info/vcf-variant-info-widget.js"></script>

    <!-- <script type="text/javascript" src="../../check-deprecated/legend-panel.js"></script> -->
    <!-- <script type="text/javascript" src="../../check-deprecated/legend-widget.js"></script> -->

    <script type="text/javascript" src="../lib/widgets/ux-window.js"></script>

    <!-- **** -->

    <script type="text/javascript" src="navigation-bar.js"></script>
    <script type="text/javascript" src="chromosome-panel.js"></script>
    <script type="text/javascript" src="karyotype-panel.js"></script>
    <script type="text/javascript" src="status-bar.js"></script>

    <script type="text/javascript" src="tracks/tracklist-panel.js"></script>
    <script type="text/javascript" src="tracks/track.js"></script>
    <script type="text/javascript" src="tracks/feature-track.js"></script>
    <script type="text/javascript" src="tracks/gene-track.js"></script>
    <script type="text/javascript" src="tracks/alignment-track.js"></script>

    <script type="text/javascript" src="renderers/renderer.js"></script>
    <script type="text/javascript" src="renderers/feature-renderer.js"></script>
    <script type="text/javascript" src="renderers/feature-cluster-renderer.js"></script>
    <script type="text/javascript" src="renderers/sequence-renderer.js"></script>
    <script type="text/javascript" src="renderers/histogram-renderer.js"></script>
    <script type="text/javascript" src="renderers/gene-renderer.js"></script>
    <script type="text/javascript" src="renderers/alignment-renderer.js"></script>
    <script type="text/javascript" src="renderers/variant-renderer.js"></script>


    <!--<script type="text/javascript" src="fakeBam.js"></script>-->


    <script type="text/javascript" src="genome-viewer.js"></script>
    <!-- /build -->


    <!-- ES6 -->
    <script type="text/javascript" src="../lib/data-adapter/feature/cellbase-adapter-new.js"></script>
    <script type="text/javascript" src="../lib/data-adapter/feature/opencga-adapter-new.js"></script>
    <script type="text/javascript" src="../lib/cache/indexeddb-cache.js"></script>
    <script type="text/javascript" src="../lib/clients/cellbase-client.js"></script>
    <script type="text/javascript" src="../lib/clients/cellbase-client-config.js"></script>
    <script type="text/javascript" src="../lib/clients/rest-client.js"></script>
    <script type="text/javascript" src="../lib/clients/opencga-client.js"></script>
    <script type="text/javascript" src="../lib/clients/opencga-client-config.js"></script>


    <!-- Google Analytics -->
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-16414504-2']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>


    <style type="text/css">
        html {
            width: 100%;
            height: 100%;
            position: relative;
            overflow-x: hidden;
        }

        body {
            margin: 0px;
        }

        #application {
            box-sizing: border-box;
            margin: 0 auto;
            width: 1500px;
            border: 1px solid lightgray;
        }

        #title {
            margin: 20px auto;
            width: 1500px;
            font-size: 35px;
            color: gray;
        }
    </style>

</head>

<body class="ocb">

    <div id="title">Genome Viewer</div>
    <div id="application"></div>

<script type="text/javascript">

    // We first parse URL to check (and overwrite) if a CellBase Host and Version have been provided
    var queryParams = URI.parseQuery(window.location.search);
    if (typeof queryParams.CELLBASE_HOST !== "undefined") {
        CELLBASE_HOST = queryParams.CELLBASE_HOST;
    }
    if (typeof queryParams.CELLBASE_VERSION !== "undefined") {
        CELLBASE_VERSION = queryParams.CELLBASE_VERSION;
    }
    console.log("CellBase Host: " + CELLBASE_HOST, " - CellBase Version: " + CELLBASE_VERSION)

    var cellBaseClientConfig = new CellBaseClientConfig(hosts = CELLBASE_HOST, version = CELLBASE_VERSION);
    var cellbaseClient = new CellBaseClient(cellBaseClientConfig);

    // We parse the URL to check (and overwrite) the OPENCGA parameters as well
    if (typeof queryParams.OPENCGA_HOST !== "undefined") {
        OPENCGA_HOST = queryParams.OPENCGA_HOST;
    }
    if (typeof queryParams.OPENCGA_USER !== "undefined") {
        OPENCGA_USER = queryParams.OPENCGA_USER;
    }
    if (typeof queryParams.OPENCGA_PASSWORD !== "undefined") {
        OPENCGA_PASSWORD = queryParams.OPENCGA_PASSWORD;
    }
    console.log("Opencga host: " + OPENCGA_HOST, " - User: " + OPENCGA_USER, " - Password: " + OPENCGA_PASSWORD);

    var opencgaClientConfig = new OpenCGAClientConfig(OPENCGA_HOST);
    opencgaClientConfig.setPrefix("gm");
    var opencgaClient = new OpenCGAClient(opencgaClientConfig);

    opencgaClient.users().login(OPENCGA_USER, OPENCGA_PASSWORD)
            .then(function() {
                console.log("User " + OPENCGA_USER + " successfully logged in in opencga.");
            })
            .catch(function(e) {
                console.log("Error logging in " + OPENCGA_USER, e);
            });

    // Take the file id to show the alignment track
    let fileId;
    if (typeof queryParams.BAM_NAME !== "undefined") {
        fileId = queryParams.BAM_NAME;
    }

    var genomeViewer;
    var region = new Region({chromosome: "13", start: 32889611, end: 32889611});
    //        var region = new Region({chromosome: "X", start: 139865187, end: 139865193});


//    let x = new CellBaseAdapter(cellbaseClient, "genomic", "region", "gene",
//            {
//                exclude: 'transcripts.tfbs,transcripts.xrefs,transcripts.exons.sequence'
//            }, {
//                chunkSize: 100000
//            });
//    x.getData({
//        region: {
//            chromosome: "13",
//            start: 32889611,
//            end: 32889611
//        }
//    });
    getSpecies(function(s) {
        AVAILABLE_SPECIES = s;
        run();
    });

    function getSpecies(callback) {
        cellbaseClient.getMeta("species").then(function(r) {
            var taxonomies = r.response[0].result[0];
            for (var taxonomy in taxonomies) {
                var newSpecies = [];
                for (var i = 0; i < taxonomies[taxonomy].length; i++) {
                    var species = taxonomies[taxonomy][i];
                    for (var j = 0; j < species.assemblies.length; j++) {
                        var s = Utils.clone(species)
                        s.assembly = species.assemblies[j];
                        delete s.assemblies;
                        newSpecies.push(s)
                    }
                }
                taxonomies[taxonomy] = newSpecies;
            }
            callback(taxonomies);
        });
    }

    function run() {

        var species = AVAILABLE_SPECIES.vertebrates[0];

        genomeViewer = new GenomeViewer({
            client: cellbaseClient,
            cellBaseHost: CELLBASE_HOST,
            cellBaseVersion: CELLBASE_VERSION,
            target: 'application',
            width: document.querySelector('#application').getBoundingClientRect().width,
            region: region,
            availableSpecies: AVAILABLE_SPECIES,
            species: species,
            sidePanel: false,
            autoRender: true,
            resizable: true,
            karyotypePanelConfig: {
                collapsed: false,
                collapsible: true
            },
            chromosomePanelConfig: {
                collapsed: false,
                collapsible: true
            },
            navigationBarConfig: {
                componentsConfig: {
                }
            },
            handlers: {
                'region:change': function(e) {
                    console.log(e)
                }
            }
        });

        tracks = [];

        this.sequence = new FeatureTrack({
            title: 'Sequence',
            height: 20,
            visibleRegionSize: 200,

            renderer: new SequenceRenderer(),
            dataAdapter: new CellBaseAdapter(cellbaseClient, "genomic", "region", "sequence", {}, { chunkSize: 1000})
        });
        tracks.push(this.sequence);

        this.gene = new GeneTrack({
            title: 'Gene',
            minHistogramRegionSize: 20000000,
            maxLabelRegionSize: 10000000,
            minTranscriptRegionSize: 200000,
            height: 100,

            renderer: new GeneRenderer({
                handlers: {
                    'feature:click': function(e) {
                        console.log(e)
                    }
                }
            }),

            dataAdapter: new CellBaseAdapter(cellbaseClient, "genomic", "region", "gene",
                    {
                        exclude: 'transcripts.tfbs,transcripts.xrefs,transcripts.exons.sequence'
                    }, {
                        chunkSize: 100000
                    })
        });

        tracks.push(this.gene);

        let alignment = new AlignmentTrack({
            title: "Alignment",
            closable: true,
            //minHistogramRegionSize: 12000,
            //maxLabelRegionSize: 3000,
            //visibleRegionSize: 9000,
            height: 150,
            renderer: new AlignmentRenderer(FEATURE_TYPES.alignment),
            dataAdapter: new OpencgaAdapter(opencgaClient, "analysis/alignment", undefined, "query", {fileId: fileId})
        });

        tracks.push(alignment);
        /*
        * var adapter = new OpencgaAdapter({
         category: "alignments",
         host: host,
         resource: object,
         species: this.genomeViewer.species,
         params: {
         sid: Cookies('bioinfo_sid')
         },
         cacheConfig: {
         chunkSize: 5000,
         cacheId: Cookies('bioinfo_sid') + 'opencga' + object.id,
         }
         });
         var renderer = new AlignmentRenderer(FEATURE_TYPES.alignment);
         track = new AlignmentTrack({
         title: trackTitle,
         closable: true,
         //minHistogramRegionSize: 12000,
         //maxLabelRegionSize: 3000,
         //visibleRegionSize: 9000,
         height: 150,
         renderer: renderer,
         dataAdapter: adapter
         });
         this.genomeViewer.addTrack(track);
        * */

//        var renderer = new FeatureRenderer(FEATURE_TYPES.gene);
//        renderer.on({
//            'feature:click': function(event) {
//                // feature click event example
//                console.log(event)
//            }
//        });
//        var gene = new FeatureTrack({
////        title: 'Gene overview',
//            minHistogramRegionSize: 20000000,
//            maxLabelRegionSize: 10000000,
//            height: 100,
//
//            renderer: renderer,
//
//            dataAdapter: new CellBaseAdapter(cellbaseClient, "genomic", "region", "gene",
//                    {
//                        exclude: 'transcripts,chunkIds'
//                    }, {
//                        chunkSize: 100000
//                    })
//        });
//
//        genomeViewer.addOverviewTrack(gene);

//        this.snp = new FeatureTrack({
//            title: 'Variation',
//            featureType: 'SNP',
//            minHistogramRegionSize: 12000,
//            maxLabelRegionSize: 3000,
//            height: 120,
//
//            renderer: new FeatureRenderer(FEATURE_TYPES.snp),
//
//            dataAdapter: new CellBaseAdapter(cellbaseClient, "genomic", "region", "snp",
//                    {
//                        exclude: 'annotation.populationFrequencies,annotation.additionalAttributes,transcriptVariations,xrefs,samples'
//                    }, {
//                        chunkSize: 10000
//                    })
//        });
//
//        tracks.push(this.snp);

/*************************/
//        var customTrack = new FeatureTrack({
//            title: 'custom track',
//            minHistogramRegionSize: 12000,
//            maxLabelRegionSize: 3000,
//            height: 120,
//
//            renderer: new FeatureRenderer(),
//
//            dataAdapter: new FeatureTemplateAdapter({
//              multiRegions: true,
//              histogramMultiRegions: false,
//              uriTemplate: 'https://dcc.icgc.org/api/browser/gene?segment={region}&resource=gene',
//              cacheConfig: {
//                chunkSize: 100000
//              }
//            })
//        });
//        tracks.push(customTrack);
/*************************/


        genomeViewer.addTrack(tracks);

        genomeViewer.draw();

    }

</script>

</body>
</html>
