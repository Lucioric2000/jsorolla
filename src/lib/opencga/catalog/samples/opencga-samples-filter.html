<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<link rel="import" href="../filters/opencga-annotation-filter-widget.html">

<dom-module id="opencga-samples-filter">
    <template>
        <style is="custom-style" include="jso-styles">
            .border-padding {
                padding-top: 5px;
                padding-right: 3px;
                padding-bottom: 5px;
                padding-left: 8px;
            }
        </style>

        <div>

            <!--<button type="button" class="btn btn-default" style="margin-bottom: 15px;" on-click="clear">Clear all-->
            <!--</button>-->

            <div class="panel-group" id="{{prefix}}Accordion">
                <!--Sample name-->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <!--<i hidden$="{{!sampleNameSearch.length}}" class="fa fa-check" aria-hidden="true" style="color: green;"></i>-->
                            <!--<i hidden$="{{!sampleSourceSearch.length}}" class="fa fa-check" aria-hidden="true"-->
                               <!--style="color: green;"></i>-->
                            <a href data-toggle="collapse" data-parent$="#{{prefix}}Accordion" href$="#{{prefix}}SampleNameCollapse">
                                Name
                            </a>
                        </h4>
                    </div>
                    <div id="{{prefix}}SampleNameCollapse" class="panel-collapse">
                        <div class="form-group has-feedback panel-body">
                            <!--Sample Name-->
                            Name:
                            <input type="text" id="{{prefix}}SampleName" class="form-control" placeholder="Search by sample name"
                                   on-keyup="calculateFilters" value="{{sampleNameSearch::input}}">
                            <i class="fa fa-search form-control-feedback" aria-hidden="true" style="padding: 15px; margin-right: 20px; margin-top: 18px"></i>
                            <br>
                            <!--Sample source-->
                            File:
                            <input type="text" id="{{prefix}}SampleSource" class="form-control" placeholder="Search by sample source"
                                   on-keyup="calculateFilters" value="{{sampleSourceSearch::input}}">
                            <i class="fa fa-search form-control-feedback" aria-hidden="true" style="padding: 15px; margin-right: 20px; margin-top: 92px;"></i>
                        </div>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <!--<i hidden$="{{!filteredVariables.variables.length}}" class="fa fa-check" aria-hidden="true" style="color: green;"></i>-->
                            <a href data-toggle="collapse" data-parent$="#{{prefix}}Accordion" href$="#{{prefix}}SampleVariablesCollapse">
                                Variables
                            </a>
                        </h4>
                    </div>
                    <div id="{{prefix}}SampleVariablesCollapse" class="panel-collapse collapse">
                        <div class="panel-body">
                            <opencga-annotation-filter-widget opencga-client="{{opencgaClient}}" study-id="{{studyId}}"
                                                              filtered-variables="{{filteredVariables}}">
                            </opencga-annotation-filter-widget>

                            <!--<div hidden$="{{!filteredVariables.variables.length}}" class="panel panel-success">-->
                                <!--<div class="panel-heading">Active filters <span class="badge">{{filteredVariables.variables.length}}</span>-->
                                <!--</div>-->
                                <!--<ul class="list-group" style="max-height: 150px; overflow-y: auto;">-->
                                    <!--<template is="dom-repeat" items="{{filteredVariables.variables}}" as="filter">-->
                                        <!--<li class="list-group-item">-->
                                            <!--<a on-click="removeVariableFilter" class="btn btn-default" data-variable="{{filter}}">-->
                                                <!--<i class="fa fa-times add-right-margin" aria-hidden="true"></i>-->
                                                <!--{{filter.name}}: {{filter.value}}-->
                                            <!--</a>-->
                                        <!--</li>-->
                                    <!--</template>-->
                                <!--</ul>-->
                            <!--</div>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </template>
    <script>
        Polymer({
            is: 'opencga-samples-filter',
            properties: {
                opencgaClient: {
                    type: Object
                },
                studyId: {
                    type: Number
                },
                prefix: {
                    type: String
                },
                filters: {
                    type: Object,
                    notify: true
                },
                update: {
                    type: Object,
                    value: {},
                    observer: "updateFilter"
                }
            },
            observers: [
                'calculateFilters(filteredVariables.variables.*)'
            ],
            ready: function() {
                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = "sample" + Utils.randomString(6);
                }
            },
            updateFilter: function () {
                this.filters = this.update;
                if (typeof this.update.name === "undefined") {
                    $("#" + this.prefix + "SampleName").val("");
                    this.sampleNameSearch = "";
                }

                if (typeof this.update.source === "undefined") {
                    $("#" + this.prefix + "SampleSource").val("");
                    this.sampleSourceSearch = "";
                }

                if (typeof this.update.annotation !== "undefined") {
                    for (let i = 0; i < this.update.annotation.length; i++) {
                        for (let j = 0; j < this.filteredVariables.variables.length; j++) {
                            if (this.update.annotation[i].name != this.filteredVariables.variables[j].name) {
                                this.splice("filteredVariables.variables", j, 1);
                            }
                        }
                    }
                } else {
                    this.set("filteredVariables.variables", []);
                }
            },
//            removeVariableFilter: function(e) {
//                for (let i = 0; i < this.filteredVariables.variables.length; i++) {
//                    if (e.target.dataVariable === this.filteredVariables.variables[i]) {
//                        this.splice("filteredVariables.variables", i, 1);
//                    }
//                }
//            },
            calculateFilters: function() {
                let filters = {};
                if (this.sampleNameSearch !== undefined && this.sampleNameSearch.length > 0) {
                    filters["name"] = "~" + this.sampleNameSearch;
                }
                if (this.sampleSourceSearch !== undefined && this.sampleSourceSearch.length > 0) {
                    filters["source"] = "~" + this.sampleSourceSearch;
                }
                if (this.filteredVariables.variables !== undefined && this.filteredVariables.variables.length > 0) {
                    filters["variableSetId"] = this.filteredVariables.variableSet;
                    let annotations = [];
                    this.filteredVariables.variables.forEach(function(variable) {
                        annotations.push(variable);
                    });
                    filters["annotation"] = annotations;
                }
                this.filters = filters;
            }
        });
    </script>
</dom-module>
