<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<link rel="import" href="./opencga-panel-summary.html">

<dom-module id="opencga-panel-list">
    <template>
        <style include="jso-styles">
            .div-margin {
                margin-top: 20px;
            }
        </style>

        <div class="col-md-2 div-margin">
            <div style="width: 60%;margin: 0 auto">
                <button type="button" class="btn btn-lg btn-primary" style="width: 100%" on-click="onSearch">
                    <i class="fa fa-search" aria-hidden="true" style="padding: 0px 5px"></i> Search
                </button>
            </div>
            <div class="form-group has-feedback">
                <label for="{{prefix}}NamePanel" class="col-label">Name</label>
                <input id="{{prefix}}NamePanel" type="text" class="form-control"
                       placeholder="Search for" value="{{namePanel::input}}">
            </div>
            <div class="form-group has-feedback">
                <label for="{{prefix}}AuthorPanel" class="col-label">Author</label>
                <input id="{{prefix}}AuthorPanel" type="text" class="form-control"
                       placeholder="Search for" value="{{authorPanel::input}}">
            </div>
            <div class="form-group has-feedback">
                <label for="{{prefix}}VersionPanel" class="col-label">Version</label>
                <input id="{{prefix}}VersionPanel" type="text" class="form-control"
                       placeholder="Search for" value="{{versionPanel::input}}">
            </div>


        </div>
        <div class="col-md-10 div-margin">
            <div id="{{prefix}}InstallationPanelsDiv">
                <h2>Installation Panels</h2>
                <button id="{{prefix}}ImportInstallationPanel" type="button" on-click="importInstallationPanel" class="btn btn-danger variant-prioritization-view-buttons" style="margin: 1% 1%; float: right;">
                    <i class="fa fa-copy icon-padding" aria-hidden="true" ></i> Import
                </button>
                <table id="{{prefix}}InstallationPanelsGrid" data-pagination="true" data-page-list="[5, 10, 25, 50]">
                </table>
            </div>
            <opencga-panel-summary opencga-session="{{opencgaSession}}" opencga-client="{{opencgaClient}}" panel-selected="{{installationPanelSelected}}"></opencga-panel-summary>
            <div id="{{prefix}}PanelsDiv">
                <h2>Panels</h2>
                <table id="{{prefix}}PanelsGrid" data-pagination="true" data-page-list="[5, 10, 25, 50]">
                </table>
            </div>
            <opencga-panel-summary opencga-session="{{opencgaSession}}" opencga-client="{{opencgaClient}}" panel-selected="{{panelSelected}}"></opencga-panel-summary>
        </div>

    </template>

    <script>
        class OpencgaPanelList extends Polymer.Element {

            constructor() {
                super();
                this.prefix = "PanelList" + Utils.randomString(6);
            }

            static get is() {
                return 'opencga-panel-list';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object
                    },
                    opencgaClient: {
                        type: Object
                    },
                    cellbaseClient: {
                        type: Object
                    },
                    panelExamples: {
                        type: Array
                    }
                }
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            connectedCallback() {
                super.connectedCallback();
                this.renderPanelTable();
                this.renderInstallationPanelTable();
            }

            renderPanelTable() {
                // Check that HTTP protocol is present and complete the URL
                let opencgaHostUrl = this.opencgaClient.getConfig().host;
                if (!opencgaHostUrl.startsWith("http://") && !opencgaHostUrl.startsWith("https://")) {
                    opencgaHostUrl = 'http://' + opencgaHostUrl;
                }
                opencgaHostUrl += '/webservices/rest/v1/diseasePanels/search';

                let _table = $('#' + this.prefix + 'PanelsGrid');

                let _this = this;
                let queryParams = this.query;
                $(_table).bootstrapTable('destroy');
                $(_table).bootstrapTable({
                    url: opencgaHostUrl,
//                    data: this.panelExamples,
                    columns: _this._createPanels(),
                    method: 'get',
                    sidePagination: 'server',
                    filterControl: true,
                    queryParams: function (params) {
                        let auxParams = {
                            study: _this.opencgaSession.study.fqn,
                            //                                lazy: "false",
                            sid: Cookies.get(_this.opencgaClient.getConfig().cookieSessionId),
//                            order: params.order,
//                            sort: params.sort,
                            limit: params.limit,
                            skip: params.offset,
                            include: "name,author,version,description,genes,variants,phenotypes"
                        };

                        return Object.assign({}, auxParams, queryParams);
                    },
                    responseHandler: function (response) {
                        if (!_this.hasOwnProperty("numTotalResults")) {
                            _this.numTotalResults = 0;
                        }
                        if (_this.numTotalResults !== response.response[0].numTotalResults
                            && response.queryOptions.skip === 0) {
                            _this.numTotalResults = response.response[0].numTotalResults;
                        }

                        _this.numTotalResultsText = _this.numTotalResults.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

                        if(response.queryOptions.skip === 0 && _this.numTotalResults < response.queryOptions.limit){
                            _this.from = 1;
                            _this.to = _this.numTotalResults;
                        }

                        return {
                            total: _this.numTotalResults,
                            rows: response.response[0].result
                        };
                    },
                    onClickRow: function (row, element, field) {
                        $('.success').removeClass('success');
                        $(element).addClass('success');
                        _this.selectPanel(row);
                    },
                    onLoadSuccess: function (data) {
                        PolymerUtils.querySelector(_table.selector).rows[1].setAttribute('class', 'success');
//                        _this.selectPanel(data[0]);

                    },
                    onPageChange: function (page, size) {
                        _this.from = (page - 1) * size + 1;
                        _this.to = page * size;
                    },
                    onPostBody: function(data) {
                        PolymerUtils.querySelector(_table.selector).rows[1].setAttribute('class', 'success');
                        // _this.panelSelected = data[0];
                        _this.selectPanel(data[0]);
                    }
                });
            }


            renderInstallationPanelTable() {
                // Check that HTTP protocol is present and complete the URL
                let opencgaHostUrl = this.opencgaClient.getConfig().host;
                if (!opencgaHostUrl.startsWith("http://") && !opencgaHostUrl.startsWith("https://")) {
                    opencgaHostUrl = 'http://' + opencgaHostUrl;
                }
                opencgaHostUrl += '/webservices/rest/v1/diseasePanels/search';

                let _table = $('#' + this.prefix + 'InstallationPanelsGrid');

                let _this = this;
                let queryParams = this.query;
                $(_table).bootstrapTable('destroy');
                $(_table).bootstrapTable({
                    url: opencgaHostUrl,
//                    data: this.panelExamples,
                    columns: _this._createPanels(),
                    method: 'get',
                    sidePagination: 'server',
                    filterControl: true,
                    queryParams: function (params) {
                        let auxParams = {
                            study: _this.opencgaSession.study.fqn,
//                                lazy: "false",
                            sid: Cookies.get(_this.opencgaClient.getConfig().cookieSessionId),
//                            order: params.order,
//                            sort: params.sort,
                            globalPanels: true,
                            limit: params.limit,
                            skip: params.offset,
                            include: "name,author,version,description,genes,variants,phenotypes"
                        };

                        return Object.assign({}, auxParams, queryParams);
                    },
                    responseHandler: function (response) {
                        if (!_this.hasOwnProperty("numTotalResults")) {
                            _this.numTotalResults = 0;
                        }
                        if (_this.numTotalResults !== response.response[0].numTotalResults
                                && response.queryOptions.skip === 0) {
                            _this.numTotalResults = response.response[0].numTotalResults;
                        }

                        _this.numTotalResultsText = _this.numTotalResults.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

                        if(response.queryOptions.skip === 0 && _this.numTotalResults < response.queryOptions.limit){
                            _this.from = 1;
                            _this.to = _this.numTotalResults;
                        }

                        return {
                            total: _this.numTotalResults,
                            rows: response.response[0].result
                        };
                    },
                    onClickRow: function (row, element, field) {
                        $('.success').removeClass('success');
                        $(element).addClass('success');
                        _this.selectInstallationPanel(row);
                    },
                    onLoadSuccess: function (data) {
                        PolymerUtils.querySelector(_table.selector).rows[1].setAttribute('class', 'success');
//                        _this.selectPanel(data[0]);

                    },
                    onPageChange: function (page, size) {
                        _this.from = (page - 1) * size + 1;
                        _this.to = page * size;
                    },
                    onPostBody: function(data) {
                        PolymerUtils.querySelector(_table.selector).rows[1].setAttribute('class', 'success');
                        // _this.panelSelected = data[0];
                        _this.selectInstallationPanel(data[0]);
                    }
                });
            }

            onSearch(e) {
                let query = {};
                if (UtilsNew.isNotEmpty(this.namePanel)) {
                    query.name = this.namePanel;
                }
                if (UtilsNew.isNotEmpty(this.authorPanel)) {
                    query.author = this.authorPanel;
                }
                if (UtilsNew.isNotEmpty(this.versionPanel)) {
                    query.version = this.versionPanel;
                }

                this.query = Object.assign({}, query);
                this.renderPanelTable();
                this.renderInstallationPanelTable();
            }

            selectPanel(panel) {
                this.panelSelected = panel;
                this.dispatchEvent(new CustomEvent("panelselected", {
                    detail: this.panelSelected,
                    bubbles: true,
                    composed: true
                }));
            }

            selectInstallationPanel(panel) {
                this.installationPanelSelected = panel;
            }

            importInstallationPanel() {
                if (UtilsNew.isNotUndefinedOrNull(this.installationPanelSelected)) {
                    this.dispatchEvent(new CustomEvent("importpanel", {
                        detail: this.installationPanelSelected,
                        bubbles: true,
                        composed: true
                    }));
                }

            }

            // panelFormatter(value, row, index) {
            //     return "<span style='white-space: nowrap'>" + index + "</span>";
            // }
            genesFormatter(value, row, index) {
                return UtilsNew.isNotEmptyArray(row.genes) ? row.genes.length : 0;
            }
            phenotypesFormatter(value, row, index) {
                return UtilsNew.isNotEmptyArray(row.phenotypes) ? row.phenotypes.length : 0;
            }



            _createPanels() {
                return [
                    [
                        {
                            title: 'Name',
                            field: 'name',
                            // sortable: true,
                            colspan: 1,
                            rowspan: 1,
                            halign: 'center',
                            searchable: true
                        },
                        {
                            title: 'Number of Genes',
                            // sortable: true,
                            colspan: 1,
                            rowspan: 1,
                            halign: 'center',
                            formatter: this.genesFormatter,
                        },
                        {
                            title: 'Number of Phenotypes',
                            // sortable: true,
                            colspan: 1,
                            rowspan: 1,
                            halign: 'center',
                            formatter: this.phenotypesFormatter,
                        }
                    ]
                ];
            }


            _createDefaultColumns() {
                return [
                    [
                        {
                            title: 'Panel',
                            field: 'name',
                            // sortable: true,
                            colspan: 1,
                            rowspan: 1,
                            halign: 'center',
                            searchable: true
                        }
                    ]
                ];
            }
        }

        customElements.define(OpencgaPanelList.is, OpencgaPanelList);
    </script>
</dom-module>
