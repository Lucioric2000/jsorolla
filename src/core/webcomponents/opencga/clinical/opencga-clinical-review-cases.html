<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="opencga-clinical-analysis-grid.html">

<dom-module id="opencga-clinical-review-cases">
    <template>
        <style include="jso-styles">
            .ocap-text-button {
                display: inline-block;
                overflow: hidden;
                width: 90px;
                text-align: left;
                float: left !important;
            }

            .filter-label {
                margin: auto 10px;
                white-space: nowrap
            }

            .browser-variant-tab-title {
                font-size: 115%;
                font-weight: bold;
            }
        </style>

        <div class="row">
            <div class="col-md-12">

                <!--<div>-->
                    <!--<h2 style="margin-top: 10px">{{_config.title}}</h2>-->
                <!--</div>-->

                <div style="padding: 10px 10px;">

                    <div class="panel panel-default" style="margin-bottom: 10px">
                        <!--<div class="panel-heading">Case Filters</div>-->
                        <div class="panel-body" style="padding: 10px">

                            <div class="btn-group" style="padding-right: 20px">
                                <label>Filters</label>
                            </div>

                            <!-- Case ID -->
                            <div class="btn-group">
                                <button type="button" class="dropdown-toggle btn btn-default" style="width:125px; color: rgb(153, 153, 153);"
                                        id="{{prefix}}caseMenu" title="{{case}}"
                                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span class="ocap-text-button">Case: {{case}}</span>&nbsp;<span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="{{prefix}}caseMenu">
                                    <li style="padding: 5px;">
                                        <div style="display: inline-flex; width: 300px;">
                                            <label class="filter-label">Case ID:</label>
                                            <input type="text" id="{{prefix}}caseInput" class$="{{prefix}}-input form-control" data-id="case" placeholder="All" on-keyup="onFilterInputText">
                                        </div>
                                    </li>
                                </ul>
                            </div>

                            <!-- Proband -->
                            <div class="btn-group">
                                <button type="button" class="btn btn-default dropdown-toggle" style="width:125px; color: rgb(153, 153, 153);"
                                        id="{{prefix}}probandMenu" title="{{proband}}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span class="ocap-text-button">Proband: {{proband}}</span>&nbsp; <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="{{prefix}}probandMenu">
                                    <li style="padding: 5px;">
                                        <div style="display: inline-flex;width: 300px">
                                            <label class="filter-label">Proband ID:</label>
                                            <input type="text" id="{{prefix}}probandInput" class$="{{prefix}}-input form-control" data-id="proband" placeholder="All" on-keyup="onFilterInputText">
                                        </div>
                                    </li>
                                </ul>
                            </div>

                            <!-- Family -->
                            <div class="btn-group">
                                <button type="button" class="dropdown-toggle btn btn-default" style="width:125px; color: rgb(153, 153, 153);"
                                        id="{{prefix}}familyMenu" title="{{family}}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span class="ocap-text-button">Family: {{family}}</span>&nbsp; <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="{{prefix}}FamilyMenu">
                                    <li style="padding: 5px;">
                                        <div style="display: inline-flex; width: 300px;">
                                            <label class="filter-label">Family ID:</label>
                                            <input type="text" id="{{prefix}}familyInput" class$="{{prefix}}-input form-control" data-id="family" placeholder="All" on-keyup="onFilterInputText">
                                        </div>
                                    </li>
                                </ul>
                            </div>

                            <!-- Disorder -->
                            <div class="btn-group">
                                <button type="button" class="dropdown-toggle btn btn-default" style="width:125px; color: rgb(153, 153, 153);"
                                        id="{{prefix}}disorderMenu" title="{{disorder}}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span class="ocap-text-button">Disorder: {{disorder}}</span>&nbsp; <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="{{prefix}}DisorderMenu">
                                    <li style="padding: 5px;">
                                        <div style="display: inline-flex; width: 300px;">
                                            <label class="filter-label">Disorder ID:</label>
                                            <input type="text" id="{{prefix}}disorderInput" class$="{{prefix}}-input form-control" data-id="disorder" placeholder="All" on-keyup="onFilterInputText">
                                        </div>
                                    </li>
                                </ul>
                            </div>

                            <!-- Type -->
                            <div class="btn-group">
                                <select class="selectpicker" data-width="125px" id="{{prefix}}-type" multiple
                                        title="Type: All" on-change="updateQuery" style="width:125px; color: rgb(153, 153, 153);">
                                    <option value="SINGLE">Single</option>
                                    <option value="FAMILY">Family</option>
                                    <option value="CANCER">Cancer</option>
                                    <option value="COHORT">Cohort</option>
                                    <option value="AUTOCOMPARATIVE">Autocomparative</option>
                                </select>
                            </div>

                            <!-- Status -->
                            <div class="btn-group">
                                <select class="selectpicker" data-width="125px" id="{{prefix}}-status" multiple
                                        title="Status: All" on-change="updateQuery">
                                    <option value="INCOMPLETE">Incomplete</option>
                                    <option value="READY_FOR_VALIDATION">Ready for Validation</option>
                                    <option value="READY_FOR_INTERPRETATION">Ready for Interpretation</option>
                                    <option value="INTERPRETATION_IN_PROGRESS">Interpretation in Progress</option>
                                    <option value="READY_FOR_INTEPRETATION_REVIEW">Ready for Interpretation Review</option>
                                    <option value="INTERPRETATION_REVIEW_IN_PROGRESS">Interpretation Review in Progress</option>
                                    <option value="READY_FOR_REPORT">Ready for Report</option>
                                    <option value="REPORT_IN_PROGRESS">Report in Progress</option>
                                    <option value="DONE">Done</option>
                                    <option value="REVIEW_IN_PROGRESS">Final Review in Progress</option>
                                    <option value="REJECTED">Rejected</option>
                                    <option value="CLOSED">Closed</option>
                                </select>
                            </div>

                            <!-- Priority -->
                            <div class="btn-group">
                                <select class="selectpicker" data-width="125px" id="{{prefix}}-priority" multiple
                                        title="Priority: All" on-change="updateQuery">
                                    <option style="color: red; font-weight: bold;" value="URGENT">Urgent</option>
                                    <option style="color: orange; font-weight: bold;" value="HIGH">High</option>
                                    <option style="color: blue; font-weight: bold;" value="MEDIUM">Medium</option>
                                    <option style="color: green; font-weight: bold;" value="LOW">Low</option>
                                </select>
                            </div>

                            <!-- Assignees -->
                            <div class="btn-group">
                                <select class="selectpicker" data-width="125px" id="{{prefix}}-assigned" multiple
                                        title="Assignee: All" on-change="updateQuery">
                                    <template is="dom-repeat" items="{{_studyUsers}}" on-dom-change="_updateValidateFormFields">
                                        <option value="{{item}}">{{item}}</option>
                                    </template>
                                </select>
                            </div>

                            <!-- Buttons -->
                            <button class="btn btn-default" style="margin-left: 15px;" type="button" on-click="onClearQuery">
                                <i class="fa fa-times" aria-hidden="true"></i>
                            </button>

                            <button class="btn btn-default" type="button" on-click="updateQuery">
                                <i class="fa fa-search" aria-hidden="true"></i>
                            </button>


                            <!--<template is="dom-if" if="{{showSelectFilters(opencgaClient._config)}}">-->
                            <div class="btn-group" style="float: right">
                                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="fa fa-filter" aria-hidden="true" style="padding-right: 5px"></i> Filters <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-right">
                                    <li><a style="font-weight: bold">Saved Filters</a></li>
                                    <template is="dom-repeat" items="{{_config.filter.examples}}">
                                        <li>
                                            <template is="dom-if" if="{{!item.active}}">
                                                <a data-filter-name$="{{item.name}}" style="cursor: pointer" on-click="onFilterChange" class="filtersLink">&nbsp;&nbsp;{{item.name}}</a>
                                            </template>
                                            <template is="dom-if" if="{{item.active}}">
                                                <a data-filter-name$="{{item.name}}" style="cursor: pointer;color: green" on-click="onFilterChange" class="filtersLink">&nbsp;&nbsp;{{item.name}}</a>
                                            </template>
                                        </li>
                                    </template>
                                    <template is="dom-if" if="{{checkSid(opencgaSession.opencgaClient._config)}}">
                                        <li role="separator" class="divider"></li>
                                        <li>
                                            <a style="cursor: pointer" on-click="launchModal"><i class="fa fa-floppy-o" aria-hidden="true" style="padding-right: 5px"></i> Save...</a>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                            <!--</template>-->
                        </div>
                    </div>

                    <div>
                        <opencga-clinical-analysis-grid opencga-session="{{opencgaSession}}"
                                                        search="{{_query}}" style="font-size: 12px"
                                                        on-selectanalysis="onSelectClinicalAnalysis"
                                                        active="{{active}}"
                                                        config="{{_config.grid}}">
                        </opencga-clinical-analysis-grid>

                        <!-- Bottom tabs with specific variant information -->
                        <div style="padding-top: 20px" hidden$="{{!checkVariant(variant)}}">
                            <h3>Case Study: {{clinicalAnalysis.id}}</h3>
                            <div style="padding-top: 20px">
                                <ul id="{{prefix}}ViewTabs" class="nav nav-tabs" role="tablist">
                                    <li role="presentation" class="active">
                                        <a href="#{{prefix}}Info" role="tab" data-toggle="tab" class="browser-variant-tab-title">Case Information</a>
                                    </li>
                                    <!--<li role="presentation">-->
                                        <!--<a href="#{{prefix}}Proband" role="tab" data-toggle="tab" class="browser-variant-tab-title">Proband Info</a>-->
                                    <!--</li>-->
                                </ul>

                                <div class="tab-content" style="height: 680px">
                                    <div id="{{prefix}}Info" role="tabpanel" class="tab-pane active">
                                        <div style="padding: 10px 20px; width: 90%">
                                            <opencga-clinical-analysis-view opencga-session="{{opencgaSession}}"
                                                                            clinical-analysis={{clinicalAnalysis}}
                                                                            opencga-client="{{opencgaSession.opencgaClient}}"
                                                                            style="font-size: 12px"
                                                                            config="{{config}}">
                                            </opencga-clinical-analysis-view>
                                        </div>
                                    </div>

                                    <!--<div id="{{prefix}}Proband" role="tabpanel" class="tab-pane">-->
                                        <!--<div style="padding: 10px 20px; width: 90%">-->
                                            <!--<span>Work in progress</span>-->
                                        <!--</div>-->
                                    <!--</div>-->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        class OpencgaClinicalReviewCases extends Polymer.Element {

            constructor() {
                super();
                this.prefix = "ocrc-" + Utils.randomString(6);
            }

            static get is() {
                return 'opencga-clinical-review-cases';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object
                    },
                    query: {
                        type: Object
                    },
                    config: {
                        type: Object
                    }
                }
            }

            static get observers() {
                return ['propertyObserver(opencgaSession, query)'];
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            connectedCallback() {
                super.connectedCallback();

                this.case = "All";
                this.proband = "All";
                this.family = "All";
                this.disorder = "All";

                this.active = true;

                $('select.selectpicker').selectpicker('render');
            }

            propertyObserver(opencgaSession, query) {
                this._config = Object.assign({}, this.getDefaultConfig(), this.config);

                if (UtilsNew.isNotUndefinedOrNull(opencgaSession) && UtilsNew.isNotUndefinedOrNull(opencgaSession.study)
                    && UtilsNew.isNotEmptyArray(opencgaSession.study.groups)) {
                    // let _studyUsers = [opencgaSession.user.id];
                    for (let group of opencgaSession.study.groups) {
                        if (group.id === "@members" || group.name === "@members") {
                            this._studyUsers = group.userIds;
                        }
                    }
                }

                if (UtilsNew.isNotUndefinedOrNull(this.query)) {
                    this.setQueryFilters(this.query);
                    this._query = Object.assign({}, this.query);
                }
            }

            checkSid(config) {
                return UtilsNew.isNotEmpty(config.sessionId);
            }

            onClearQuery(e) {
                $(`#${this.prefix}-type`).selectpicker('val', '');
                $(`#${this.prefix}-priority`).selectpicker('val', '');
                $(`#${this.prefix}-status`).selectpicker('val', '');
                $(`#${this.prefix}-assigned`).selectpicker('val', '');

                // We create a dummy event so the input listeners are called and everything is automatically cleaned up
                let event = new CustomEvent("keyup", {});
                let inputElements = PolymerUtils.querySelectorAll(`.${this.prefix}-input`);
                for (let i = 0; i < inputElements.length; i++) {
                    inputElements[i].value = "";
                    inputElements[i].dispatchEvent(event);
                }

                this.updateQuery();
            }

            onSelectClinicalAnalysis(e) {
                this.clinicalAnalysis = e.detail.analysis;
            }

            onFilterChange(e) {
                for (let exampleFilter of this._config.filter.examples) {
                    if (e.currentTarget.dataset.filterName === exampleFilter.name) {
                        this._query = exampleFilter.query;
                        this.setQueryFilters(this._query);
                        break;
                    }
                }
            }

            onFilterInputText(e) {
                let filterId = e.currentTarget.dataset.id;
                let value = e.currentTarget.value;

                this.updateInputTextMenuItem(filterId, value);
            }

            updateInputTextMenuItem(filterId, value) {
                let buttonElem = PolymerUtils.getElementById(this.prefix + filterId + "Menu");
                if (UtilsNew.isNotEmpty(value)) {
                    this[filterId] = value;
                    buttonElem.style.color = "#333";
                } else {
                    this[filterId] = "All";
                    buttonElem.style.color = "rgb(153, 153, 153)";
                }
            }

            updateQuery() {
                let _query = {};

                let defaultValue = "All";

                if (this.case !== defaultValue && this.case !== "") {
                    _query.id = this.case;
                }

                if (this.proband !== defaultValue) {
                    _query.proband = this.proband;
                }

                if (this.family !== defaultValue) {
                    _query.family = this.family;
                }

                if (this.disorder !== defaultValue) {
                    _query.disorder = this.disorder;
                }

                let type = $(`#${this.prefix}-type`).selectpicker('val');
                if (UtilsNew.isNotEmpty(type)) {
                    _query.type = type.join(",");
                }

                let status = $(`#${this.prefix}-status`).selectpicker('val');
                if (UtilsNew.isNotEmpty(status)) {
                    _query.status = status.join(",");
                }

                let priority = $(`#${this.prefix}-priority`).selectpicker('val');
                if (UtilsNew.isNotEmpty(priority)) {
                    _query.priority = priority.join(",");
                }

                let assigned = $(`#${this.prefix}-assigned`).selectpicker('val');
                if (UtilsNew.isNotEmpty(assigned)) {
                    _query.analystAssignee = assigned.join(",");
                }

                this._query = _query;
            }

            setQueryFilters(query) {
                if (UtilsNew.isNotUndefinedOrNull(query.id)) {
                    PolymerUtils.setValue(this.prefix + "caseInput", query.id);
                    this.updateInputTextMenuItem("case", query.id);
                }

                if (UtilsNew.isNotUndefinedOrNull(query.proband)) {
                    PolymerUtils.setValue(this.prefix + "probandInput", query.proband);
                    this.updateInputTextMenuItem("proband", query.proband);
                }

                if (UtilsNew.isNotUndefinedOrNull(query.family)) {
                    PolymerUtils.setValue(this.prefix + "familyInput", query.family);
                    this.updateInputTextMenuItem("family", query.family);
                }

                if (UtilsNew.isNotUndefinedOrNull(query.disorder)) {
                    PolymerUtils.setValue(this.prefix + "disorderInput", query.disorder);
                    this.updateInputTextMenuItem("disorder", query.disorder);
                }

                if (UtilsNew.isNotUndefinedOrNull(query.type)) {
                    $("#" + this.prefix + "-type").selectpicker('val', query.type.split(","));
                }

                if (UtilsNew.isNotUndefinedOrNull(query.status)) {
                    $("#" + this.prefix + "-status").selectpicker('val', query.status.split(","));
                }

                if (UtilsNew.isNotUndefinedOrNull(query.priority)) {
                    $("#" + this.prefix + "-priority").selectpicker('val', query.priority.split(","));
                }

                if (UtilsNew.isNotUndefinedOrNull(query.assigned)) {
                    $("#" + this.prefix + "-assigned").selectpicker('val', query.analystAssignee.split(","));
                }
            }

            _updateValidateFormFields(){
                $("#" + this.prefix + "-assigned").validator('update');
            }

            getDefaultConfig() {
                return {
                    title: "Review Cases",
                    showTitle: true,
                    filter: {
                        examples: [
                            {
                                name: "High Priority",
                                active: false,
                                query: {
                                    type: "FAMILY",
                                    priority: "URGENT,HIGH",
                                    // assigned: "cafetero"
                                },
                            },
                        ]
                    },
                    grid: {
                        pageSize: 5,
                        pageList: [5, 10, 25],
                        detailView: false,
                        multiSelection: false
                    }
                }
            }
        }

        customElements.define(OpencgaClinicalReviewCases.is, OpencgaClinicalReviewCases);
    </script>
</dom-module>
