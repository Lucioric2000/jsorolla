<!--
  ~ Copyright 2015-2019 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../../cellbase/core/cellbase-gene-filter.html">

<dom-module id="opencga-panel-transcript-view">
    <template>

        <style include="jso-styles">
        </style>

        <div class="row" style="padding: 0px 10px; margin: 10px 0px;">

            <div class="col-md-12">
                <h3 class="form-section-title">Low Coverage Regions</h3>
            </div>

            <div class="col-md-4">
                <label class="col-md-4" style="margin-top: 5px;">Search gene:</label>
                <cellbase-gene-filter class="col-md-6" cellbase-client="{{cellbaseClient}}" on-genechange="onInputGeneChange"></cellbase-gene-filter>
                <button type="button" class="col-md-2 btn btn-primary" on-click="onSearchGeneClicked">Search</button>
            </div>

            <div class="col-md-4">
                <label class="col-md-5" style="margin-top: 5px;">or select from list:</label>
                <select class="selectpicker col-md-7" id="{{prefix}}-geneSelect" data-width="fit">
                    <template is="dom-if" if="_panelGenesAvailable">
                        <optgroup label="Panel genes">
                            <template is="dom-repeat" items="{{_panelGenes}}">
                                <option>{{item.name}}</option>
                            </template>
                        </optgroup>
                    </template>

                    <template is="dom-if" if="_genesAvailable">
                        <optgroup label="User genes">
                            <template is="dom-repeat" items="{{_genes}}">
                                <option>{{item}}</option>
                            </template>
                        </optgroup>
                    </template>

                </select>
            </div>

        </div>

        <div class="col-md-12" style="padding: 25px 0px 5px 25px">
            <h4>Filters:</h4>

            <div style="margin: 4px 10px">
                <label style="margin-top: 5px;">Low coverage threshold: </label>
                <select class="selectpicker" id="{{prefix}}-lowCoverageThreshold" on-change="onLowCoverageThresholdChange" data-width="fit">
                    <option>5</option>
                    <option>10</option>
                    <option>15</option>
                    <option selected>20</option>
                    <option>25</option>
                    <option>30</option>
                    <option>35</option>
                    <option>40</option>
                </select>
            </div>
        </div>

        <div class="col-md-12" id="{{prefix}}-svg" style="width: 100%; margin-top: 25px;"></div>

        </div>
    </template>

    <script>
        class OpencgaPanelTranscriptView extends Polymer.Element {

            static get is() {
                return 'opencga-panel-transcript-view';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object
                    },
                    cellbaseClient: {
                        type: Object
                    },
                    clinicalAnalysis: {
                        type: Object
                    },
                    panelId: {
                        type: String
                    },
                    geneIds: {
                        type: Array
                    },
                    config: {
                        type: Object
                    }
                }
            }

            static get observers() {
                return ['propertyObserver(opencgaSession, clinicalAnalysis, panelId, geneIds, config)'];
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            constructor() {
                super();

                this._init();
            }

            _init() {
                this.prefix = "PanelTranscriptView" + Utils.randomString(6);

                this._genesAvailable = false;
                this._panelGenesAvailable = false;

                // Initially we set the default config, this will be overridden if 'config' is passed
                this._config = this.getDefaultConfig();
            }


            connectedCallback() {
                super.connectedCallback();

                // We add this first listener to get a call whenever the first element is loaded
                $(`#${this.prefix}-geneSelect`).on('loaded.bs.select', this.onGeneChange.bind(this));

                // We add this listener to receive any future change over the selected genes
                $(`#${this.prefix}-geneSelect`).on('changed.bs.select', this.onGeneChange.bind(this));
            }

            propertyObserver(opencgaSession, clinicalAnalysis, panelId, geneIds, config) {
                if (UtilsNew.isNotUndefinedOrNull(config)) {
                    this._config = Object.assign(this.getDefaultConfig(), config);
                }

                this._genesAvailable = false;
                this._panelGenesAvailable = false;

                this._genes = [];
                this._panelGenes = [];
                this._files = [];

                this._autoRenderWhenFilesAreRetrieved = false;
                this._initialiseCoverageTracks = true;

                let _this = this;
                if (UtilsNew.isNotUndefinedOrNull(opencgaSession)) {
                    if (UtilsNew.isNotEmptyArray(geneIds)) {
                        let _genes = [];
                        for (let i = 0; i < geneIds.length; i++) {
                            _genes.push(geneIds[i]);
                        }
                        this._genes = _genes;
                        this._genesAvailable = true;
                    }

                    if (UtilsNew.isNotEmpty(panelId)) {
                        this.opencgaSession.opencgaClient.panels().info(panelId, {
                            study: this.opencgaSession.study.fqn, include: "genes"})
                            .then(function(response) {
                                _this._panelGenes = response.response[0].result[0].genes;
                                _this._panelGenesAvailable = true;
                            });
                    }

                    if (UtilsNew.isNotEmpty(clinicalAnalysis)) {
                        this.opencgaSession.opencgaClient.clinical().info(clinicalAnalysis,
                            {study: this.opencgaSession.study.fqn, include: "files,proband,family,disorder"})
                            .then(function(response) {
                                let result = response.response[0].result[0];

                                let disorder = result.disorder.id;

                                let files = [];

                                let members = {}; // member_id : member
                                let samples = {}; // sample_id : member
                                for (let i = 0; i < result.family.members.length; i++) {
                                    let member = result.family.members[i];
                                    members[member.id] = member;
                                    for (let j = 0; j < member.samples.length; j++) {
                                        samples[member.samples[j].id] = member;
                                    }
                                }

                                let availableBams = {}; // sample id - file id
                                for (let key in result.files) {
                                    for (let i = 0; i < result.files[key].length; i++) {
                                        if (result.files[key][i].format === "BAM") {
                                            availableBams[key] = result.files[key][i].id;
                                        }
                                    }
                                }

                                // Get proband sample
                                for (let i = 0; i < result.proband.samples.length; i++) {
                                    if (availableBams.hasOwnProperty(result.proband.samples[i].id)) {
                                        // In theory, there should only be one BAM file available for each member
                                        files.push({
                                            id: availableBams[result.proband.samples[i].id],
                                            name: "Proband '" + result.proband.id + "'",
                                            sex: result.proband.sex,
                                            isProband: true,
                                            affectationStatus: _this._getAffectationStatus(result.proband, disorder)
                                        });

                                        // Take the bam out of the map
                                        delete availableBams[result.proband.samples[i].id];
                                    }
                                }

                                // Get mother
                                if (UtilsNew.isNotUndefinedOrNull(result.proband.mother)
                                    && UtilsNew.isNotEmpty(result.proband.mother.id)) {
                                    let motherId = result.proband.mother.id;
                                    if (members.hasOwnProperty(motherId) && availableBams.hasOwnProperty(members[motherId].samples[0].id)) {
                                        files.push({
                                            id: availableBams[members[motherId].samples[0].id],
                                            name: "Mother '" + motherId + "'",
                                            sex: members[motherId].sex,
                                            isProband: false,
                                            affectationStatus: _this._getAffectationStatus(members[motherId], disorder)
                                        });

                                        // Take the bam out of the map
                                        delete availableBams[members[motherId].samples[0].id];
                                    }
                                }

                                // Get father
                                if (UtilsNew.isNotUndefinedOrNull(result.proband.father)
                                    && UtilsNew.isNotEmpty(result.proband.father.id)) {
                                    let fatherId = result.proband.father.id;
                                    if (members.hasOwnProperty(fatherId) && availableBams.hasOwnProperty(members[fatherId].samples[0].id)) {
                                        files.push({
                                            id: availableBams[members[fatherId].samples[0].id],
                                            name: "Father '" + fatherId + "'",
                                            sex: members[fatherId].sex,
                                            isProband: false,
                                            affectationStatus: _this._getAffectationStatus(members[fatherId], disorder)
                                        });

                                        // Take the bam out of the map
                                        delete availableBams[members[fatherId].samples[0].id];
                                    }
                                }

                                // If there are any remaining BAM files, we will add them in a random position
                                for (let key in availableBams) {
                                    if (samples.hasOwnProperty(key)) {
                                        files.push({
                                            id: availableBams[key],
                                            name: "Member '" + samples[key].id + "'",
                                            sex: samples[key].sex,
                                            isProband: false,
                                            affectationStatus: _this._getAffectationStatus(samples[key], disorder)
                                        });
                                    } else {
                                        files.push({
                                            id: availableBams[key],
                                            name: "Sample '" + key + "'",
                                            isProband: false
                                        });
                                    }
                                }

                                _this._files = files;

                                if (_this._autoRenderWhenFilesAreRetrieved) {
                                    _this._displaySVG($(`#${_this.prefix}-geneSelect`).selectpicker('val'),
                                        $(`#${_this.prefix}-lowCoverageThreshold`).selectpicker('val'));

                                    this._autoRenderWhenFilesAreRetrieved = false;
                                }
                            });
                    }
                }
            }

            _getAffectationStatus(member, disorderId) {
                if (UtilsNew.isEmptyArray(member.disorders)) {
                    return "UNAFFECTED";
                }
                for (let i = 0; i < member.disorders.length; i++) {
                    if (member.disorders[i].id === disorderId) {
                        return "AFFECTED";
                    }
                }
                return "UNAFFECTED";
            }

            onLowCoverageThresholdChange(e) {
                this._displaySVG(this.lastGeneId, e.currentTarget.value);
            }

            onGeneChange(e, clickedIndex, isSelected, previousValue) {
                this._displaySVG(e.currentTarget.value, $(`#${this.prefix}-lowCoverageThreshold`).selectpicker('val'));
            }

            onInputGeneChange(e) {
                this._inputGene = e.detail.gene;
            }

            onSearchGeneClicked(e) {
                if (UtilsNew.isNotEmpty(this._inputGene)) {
                    this._displaySVG(this._inputGene, $(`#${this.prefix}-lowCoverageThreshold`).selectpicker('val'));
                }
            }

            _displaySVG(geneId, threshold) {
                if (UtilsNew.isEmptyArray(this._files)) {
                    // Probably the files are being fetched at this same moment. Force them to be rendered automatically after that
                    this._autoRenderWhenFilesAreRetrieved = true;
                    return;
                }

                if (UtilsNew.isEmpty(geneId)) {
                    return;
                }

                this.lastGeneId = geneId;

                if (this._initialiseCoverageTracks) {
                    let tracks = [];

                    for (let i = 0; i < this._files.length; i++) {

                        let style = "";
                        if (UtilsNew.isNotEmpty(this._files[i].affectationStatus)) {
                            if (this._files[i].affectationStatus === "AFFECTED") {
                                style = "color: darkred";
                            } else if (this._files[i].affectationStatus === "UNKNOWN") {
                                style = "color: gray";
                            }
                        }
                        if (this._files[i].isProband) {
                            style += ";font-weight: bold";
                        }

                        let sampleIcon = this._config.sexIConMap[this._files[i].sex];

                        let htmlTitle = `<div>
                                            <span style="${style}"> ${this._files[i].name} <i class='fa ${sampleIcon} fa-lg' style='padding-left: 5px'></i>
                                            </span>
                                        </div>`;

                        tracks.push(new LinearCoverageTrack({
                                htmlTitle: htmlTitle,
                                opencga: {
                                    client: this.opencgaSession.opencgaClient
                                },
                                targetId: `${this.prefix}-svg`
                            }, {
                                width: $(`#${this.prefix}-svg`).width()
                            })
                        );

                        this.coverageTracks = tracks;
                    }
                    this._initialiseCoverageTracks = false;
                }

                if (UtilsNew.isUndefinedOrNull(this.geneTrack)) {
                    this.geneTrack = new LinearGeneTrack({
                        name: geneId,
                        targetId: `${this.prefix}-svg`
                    }, {
                        width: $(`#${this.prefix}-svg`).width()
                    })
                }

                let _this = this;
                this.cellbaseClient.get('feature', 'gene', geneId, 'info',
                    { assembly: this.opencgaSession.project.organism.assembly }, {})
                    .then(function (response) {
                        let gene = response.response[0].result[0];

                        let region = new Region(`${gene.chromosome}:${gene.start}-${gene.end}`);

                        for (let i = 0; i < _this.coverageTracks.length; i++) {
                            _this.coverageTracks[i].draw({
                                query: {
                                    region: region,
                                    study: _this.opencgaSession.study.fqn,
                                    fileId: _this._files[i].id
                                }, config: {
                                    regionOffset: _this._config.offset,
                                    lowCoverageThreshold: threshold
                                }
                            });
                        }

                        _this.geneTrack.draw({
                            data: gene
                        });
                    });
            }

            getDefaultConfig() {
                return {
                    offset: 2500,
                    sexIConMap: {
                        MALE: "fa-mars",
                        FEMALE: "fa-venus",
                        UNKNOWN: "fa-genderless"
                    }
                }
            }
        }

        customElements.define(OpencgaPanelTranscriptView.is, OpencgaPanelTranscriptView);
    </script>
</dom-module>
