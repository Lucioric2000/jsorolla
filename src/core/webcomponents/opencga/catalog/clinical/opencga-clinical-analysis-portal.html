<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="opencga-clinical-analysis-grid.html">

<dom-module id="opencga-clinical-analysis-portal">
    <template>
        <style include="jso-styles">
            .browser-subsection {
                font-size: 1.35rem;
                font-weight: bold;
                padding: 5px 0px;
                color: #444444;
                border-bottom: 1px solid rgba(221, 221, 221, 0.8);
            }

            .ocap-text-button {
                display: inline-block;
                overflow: hidden;
                width: 90px;
                text-align: left;
                float: left !important;
            }

            .filter-label {
                margin: auto 10px;
                white-space: nowrap
            }
        </style>

        <div class="row">
            <div class="col-md-12">

                <div>
                    <h2 style="margin-top: 10px"><i class="fa fa-list" style="padding: 0px 5px"></i> {{_config.title}}</h2>
                </div>

                <div style="padding: 5px 10px;">

                    <div class="panel panel-default" style="margin-bottom: 10px">
                        <div class="panel-body" style="padding: 10px">
                            <div class="dropdown">
                                <!-- Case ID -->
                                <div class="btn-group">
                                    <button class="dropdown-toggle btn btn-default" style="width:125px; color: rgb(153, 153, 153);"
                                            type="button" title="{{case}}" id="{{prefix}}caseMenu"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        <span class="ocap-text-button">Case: {{case}}</span>&nbsp;
                                        <!--<span class="bs-caret">-->
                                            <span class="caret"></span>
                                        <!--</span>-->
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="{{prefix}}caseMenu">
                                        <li style="padding: 5px;">
                                            <div style="display: inline-flex; width: 300px;">
                                                <label class="filter-label">Case ID:</label>
                                                <input type="text" class$="{{prefix}}-input form-control" placeholder="All" on-keyup="onCaseInput">
                                            </div>
                                        </li>
                                    </ul>
                                </div>

                                <!-- Proband -->
                                <div class="btn-group">
                                    <button class="btn btn-default dropdown-toggle" style="width:125px; color: rgb(153, 153, 153);" type="button" id="{{prefix}}probandMenu"
                                            data-id="proband" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"
                                            title="{{proband}}">
                                        <span class="ocap-text-button">Proband: {{proband}}</span>&nbsp;
                                        <!--<span class="bs-caret">-->
                                            <span class="caret"></span>
                                        <!--</span>-->
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="{{prefix}}probandMenu">
                                        <li style="padding: 5px;">
                                            <div style="display: inline-flex;width: 300px">
                                                <label class="filter-label">Proband ID:</label>
                                                <input type="text" class$="{{prefix}}-input form-control" placeholder="All" on-keyup="onProbandInput">
                                            </div>
                                        </li>
                                    </ul>
                                </div>

                                <!-- Family -->
                                <div class="btn-group">
                                    <button class="dropdown-toggle btn btn-default" style="width:125px; color: rgb(153, 153, 153);"
                                            type="button" id="{{prefix}}FamilyMenu" title="{{family}}"
                                            data-id="family" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        <span class="ocap-text-button">Family: {{family}}</span>&nbsp;
                                        <!--<span class="bs-caret">-->
                                            <span class="caret"></span>
                                        <!--</span>-->
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="{{prefix}}FamilyMenu">
                                        <li style="padding: 5px;">
                                            <div style="display: inline-flex; width: 300px;">
                                                <label class="filter-label">Family ID:</label>
                                                <input type="text" class$="{{prefix}}-input form-control" placeholder="All" on-keyup="onFamilyInput">
                                            </div>
                                        </li>
                                    </ul>
                                </div>

                                <!-- Disorder -->
                                <div class="btn-group">
                                    <button class="dropdown-toggle btn btn-default" style="width:125px; color: rgb(153, 153, 153);"
                                            type="button" id="{{prefix}}DisorderMenu" title="{{disorder}}"
                                            data-id="disorder" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        <span class="ocap-text-button">Disorder: {{disorder}}</span>&nbsp;
                                        <!--<span class="bs-caret">-->
                                            <span class="caret"></span>
                                        <!--</span>-->
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="{{prefix}}DisorderMenu">
                                        <li style="padding: 5px;">
                                            <div style="display: inline-flex; width: 300px;">
                                                <label class="filter-label">Disorder ID:</label>
                                                <input type="text" class$="{{prefix}}-input form-control" placeholder="All" on-keyup="onDisorderInput">
                                            </div>
                                        </li>
                                    </ul>
                                </div>

                                <!-- Type -->
                                <select class="selectpicker" data-width="125px" id="{{prefix}}-type" multiple title="Type: All"
                                        on-change="updateQuery" style="width:125px; color: rgb(153, 153, 153);">
                                    <option value="SINGLE">Single</option>
                                    <option value="FAMILY">Family</option>
                                    <option value="CANCER">Cancer</option>
                                    <option value="COHORT">Cohort</option>
                                    <option value="AUTOCOMPARATIVE">Autocomparative</option>
                                </select>

                                <!-- Status -->
                                <select class="selectpicker" data-width="125px" id="{{prefix}}-status" multiple title="Status: All"
                                        on-change="updateQuery">
                                    <option value="Ready to dispatch">Ready to dispatch</option>
                                    <option value="To be reviewed">To be reviewed</option>
                                    <option value="To be closed">To be closed</option>
                                    <option value="Archived cases">Archived cases</option>
                                </select>

                                <!-- Priority -->
                                <select class="selectpicker" data-width="125px" id="{{prefix}}-priority" multiple
                                        title="Priority: All" on-change="updateQuery">
                                    <option style="color: red; font-weight: bold;" value="URGENT">Urgent</option>
                                    <option style="color: orange; font-weight: bold;" value="HIGH">High</option>
                                    <option style="color: blue; font-weight: bold;" value="MEDIUM">Medium</option>
                                    <option style="color: green; font-weight: bold;" value="LOW">Low</option>
                                </select>

                                <button class="btn btn-default" style="margin-left: 15px;" type="button" on-click="onClearQuery">
                                    <i class="fa fa-times" aria-hidden="true"></i>
                                </button>

                                <button class="btn btn-default" type="button" on-click="updateQuery">
                                    <i class="fa fa-search" aria-hidden="true"></i>
                                </button>


                                <!--<template is="dom-if" if="{{showSelectFilters(opencgaClient._config)}}">-->
                                <div class="btn-group" style="float: right">
                                    <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="fa fa-filter" aria-hidden="true" style="padding-right: 5px"></i> Filters <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-right">
                                        <li><a style="font-weight: bold">Saved Filters</a></li>
                                        <template is="dom-repeat" items="{{filters}}">
                                            <li>
                                                <template is="dom-if" if="{{!item.active}}">
                                                    <a data-filter-name$="{{item.name}}" style="cursor: pointer" on-click="onServerFilterChange" class="filtersLink">&nbsp;&nbsp;{{item.name}}</a>
                                                </template>
                                                <template is="dom-if" if="{{item.active}}">
                                                    <a data-filter-name$="{{item.name}}" style="cursor: pointer;color: green" on-click="onServerFilterChange" class="filtersLink">&nbsp;&nbsp;{{item.name}}</a>
                                                </template>
                                            </li>
                                        </template>
                                        <template is="dom-if" if="{{checkSid(opencgaClient._config)}}">
                                            <li role="separator" class="divider"></li>
                                            <li>
                                                <a style="cursor: pointer" on-click="launchModal"><i class="fa fa-floppy-o" aria-hidden="true"></i> Save...</a>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                                <!--</template>-->

                            </div>
                        </div>
                    </div>

                    <div>
                        <opencga-clinical-analysis-grid opencga-session="{{opencgaSession}}"
                                                        search="{{search}}" style="font-size: 12px"
                                                        on-selectanalysis="onSelectClinicalAnalysis"
                                                        active="{{active}}"
                                                        config="{{_config.grid}}">
                        </opencga-clinical-analysis-grid>

                        <div>
                            <h3 style="margin-bottom: 5px">Case Study: {{clinicalAnalysis.id}}</h3>
                            <clinical-analysis-view opencga-session="{{opencgaSession}}"
                                                    clinical-analysis={{clinicalAnalysis}}
                                                    opencga-client="{{opencgaSession.opencgaClient}}"
                                                    style="font-size: 12px"
                                                    config="{{config}}">
                            </clinical-analysis-view>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </template>

    <script>
        class OpencgaClinicalAnalysisPortal extends Polymer.Element {

            constructor() {
                super();
                this.prefix = "ocap-" + Utils.randomString(6);
            }

            static get is() {
                return 'opencga-clinical-analysis-portal';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object
                    },
                    search: {
                        type: Object,
                        notify: true
                    },
                    config: {
                        type: Object
                    }
                }
            }

            static get observers() {
                return ['propertyObserver(opencgaSession, config)'];
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            connectedCallback() {
                super.connectedCallback();

                this.search = {};

                this.case = "All";
                this.proband = "All";
                this.family = "All";
                this.disorder = "All";

                this.active = true;

                $('select.selectpicker').selectpicker('render');
            }

            propertyObserver(opencgaSession, config) {
                this._config = Object.assign(this.getDefaultConfig(), this.config);
            }


            onCaseInput(e) {
                let buttonElem = e.target.parentElement.parentElement.parentElement.previousSibling.previousElementSibling;

                if (UtilsNew.isNotEmpty(e.target.value)) {
                    this.case = e.target.value;
                    buttonElem.style.color = "#333";
                } else {
                    this.case = "All";
                    buttonElem.style.color = "rgb(153, 153, 153)";
                }
            }

            onProbandInput(e) {
                let buttonElem = e.target.parentElement.parentElement.parentElement.previousSibling.previousElementSibling;

                if (UtilsNew.isNotEmpty(e.target.value)) {
                    this.proband = e.target.value;
                    buttonElem.style.color = "#333";
                } else {
                    this.proband = "All";
                    buttonElem.style.color = "rgb(153, 153, 153)";
                }
            }

            onFamilyInput(e) {
                let buttonElem = e.target.parentElement.parentElement.parentElement.previousSibling.previousElementSibling;

                if (UtilsNew.isNotEmpty(e.target.value)) {
                    this.family = e.target.value;
                    buttonElem.style.color = "#333";
                } else {
                    this.family = "All";
                    buttonElem.style.color = "rgb(153, 153, 153)";
                }
            }

            onDisorderInput(e) {
                let buttonElem = e.target.parentElement.parentElement.parentElement.previousSibling.previousElementSibling;

                if (UtilsNew.isNotEmpty(e.target.value)) {
                    this.disorder = e.target.value;
                    buttonElem.style.color = "#333";
                } else {
                    this.disorder = "All";
                    buttonElem.style.color = "rgb(153, 153, 153)";
                }
            }

            onClearQuery(e) {
                $(`#${this.prefix}-priority`).selectpicker('val', '');
                $(`#${this.prefix}-status`).selectpicker('val', '');

                // We create a dummy event so the input listeners are called and everything is automatically cleaned up
                let event = new CustomEvent("keyup", {});
                let inputElements = PolymerUtils.querySelectorAll(`.${this.prefix}-input`);
                for (let i = 0; i < inputElements.length; i++) {
                    inputElements[i].value = "";
                    inputElements[i].dispatchEvent(event);
                }

                this.updateQuery();
            }

            onSelectClinicalAnalysis(e) {

                debugger
                this.clinicalAnalysis = e.detail.analysis;
            }

            updateQuery() {
                let _search = {};

                let defaultValue = "All";

                if (this.case !== defaultValue && this.case !== "") {
                    _search.id = this.case;
                }

                if (this.proband !== defaultValue) {
                    _search.proband = this.proband;
                }

                if (this.family !== defaultValue) {
                    _search.family = this.family;
                }

                if (this.disorder !== defaultValue) {
                    _search.disorder = this.disorder;
                }

                let priority = $(`#${this.prefix}-priority`).selectpicker('val');
                if (UtilsNew.isNotEmpty(priority)) {
                    _search.priority = priority.join(",");
                }

                let type = $(`#${this.prefix}-type`).selectpicker('val');
                if (UtilsNew.isNotEmpty(type)) {
                    _search.type = type.join(",");
                }

                let status = $(`#${this.prefix}-status`).selectpicker('val');
                if (UtilsNew.isNotEmpty(status)) {
                    _search.status = status.join(",");
                }

                this.search = _search;
            }

            getDefaultConfig() {
                return {
                    title: "Review Cases",
                    showTitle: true,
                    grid: {
                        pageSize: 5,
                        pageList: [5, 10, 25],
                        detailView: false,
                        multiSelection: false
                    }
                }
            }
        }

        customElements.define(OpencgaClinicalAnalysisPortal.is, OpencgaClinicalAnalysisPortal);
    </script>
</dom-module>
