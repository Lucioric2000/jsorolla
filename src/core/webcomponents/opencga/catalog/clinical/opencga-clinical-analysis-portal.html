<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="opencga-clinical-analysis-grid.html">

<dom-module id="opencga-clinical-analysis-portal">
    <template>
        <style>
            .browser-subsection {
                font-size: 1.35rem;
                font-weight: bold;
                padding: 5px 0px;
                color: #444444;
                border-bottom: 1px solid rgba(221, 221, 221, 0.8);
            }

            .ocap-text-button {
                display: inline-block;
                overflow: hidden;
                width: 86px;
                text-align: left;
                float: left !important;
            }

        </style>

        <div class="row">
            <div class="col-md-offset-1 col-md-10">

                <div class="browser-subsection">
                    <h3>Case Portal</h3>
                </div>

                <br/>

                <div style="padding: 5px 10px;">

                    <div class="panel panel-default" style="margin-bottom: 10px">
                        <div class="panel-body" style="padding: 10px">
                            <div class="dropdown">
                                <!-- Proband -->
                                <div class="btn-group">
                                    <button class="btn btn-default dropdown-toggle" style="width:125px; color: rgb(153, 153, 153);" type="button" id="{{prefix}}probandMenu"
                                            data-id="proband" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"
                                            title="{{proband}}">
                                        <span class="ocap-text-button">Proband: {{proband}}</span>&nbsp;
                                        <span class="bs-caret">
                                            <span class="caret"></span>
                                        </span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="{{prefix}}probandMenu">
                                        <li style="padding: 5px;">
                                            <div style="display: inline-flex; width: 250px;">
                                                <label style="margin: auto;">Proband ID: </label>
                                                <input style="width: 165px;" type="text" class$="{{prefix}}-input" placeholder="Any" on-keyup="onProbandInput">
                                            </div>
                                        </li>
                                    </ul>
                                </div>

                                <!-- Family -->
                                <div class="btn-group">
                                    <button class="dropdown-toggle btn btn-default" style="width:125px; color: rgb(153, 153, 153);"
                                            type="button" id="{{prefix}}familyMenu" title="{{family}}"
                                            data-id="family" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        <span class="ocap-text-button">Family: {{family}}</span>&nbsp;
                                        <span class="bs-caret">
                                            <span class="caret"></span>
                                        </span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="{{prefix}}familyMenu">
                                        <li style="padding: 5px;">
                                            <div style="display: inline-flex; width: 250px;">
                                                <label style="margin: auto;">Family ID: </label>
                                                <input style="width: 165px;" type="text" class$="{{prefix}}-input" placeholder="Any" on-keyup="onFamilyInput">
                                            </div>
                                        </li>
                                    </ul>
                                </div>

                                <!-- Case ID -->
                                <div class="btn-group">
                                    <button class="dropdown-toggle btn btn-default" style="width:125px; color: rgb(153, 153, 153);"
                                            type="button" title="{{case}}" id="{{prefix}}caseMenu"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        <span class="ocap-text-button">Case: {{case}}</span>&nbsp;
                                        <span class="bs-caret">
                                            <span class="caret"></span>
                                        </span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="{{prefix}}caseMenu">
                                        <li style="padding: 5px;">
                                            <div style="display: inline-flex; width: 250px;">
                                                <label style="margin: auto;">Case ID: </label>
                                                <input style="width: 165px;" type="text" class$="{{prefix}}-input" placeholder="Any" on-keyup="onCaseInput">
                                            </div>
                                        </li>
                                    </ul>
                                </div>

                                <!-- Status -->
                                <select class="selectpicker" data-width="125px" id="{{prefix}}-status" multiple title="Status: Any"
                                        on-change="updateQuery">
                                    <option value="Ready to dispatch">Ready to dispatch</option>
                                    <option value="To be reviewed">To be reviewed</option>
                                    <option value="To be closed">To be closed</option>
                                    <option value="Archived cases">Archived cases</option>
                                </select>

                                <!-- Priority -->
                                <select class="selectpicker" data-width="125px" id="{{prefix}}-priority" multiple
                                        title="Priority: Any" on-change="updateQuery">
                                    <option style="color: red; font-weight: bold;" value="URGENT">Urgent</option>
                                    <option style="color: orange; font-weight: bold;" value="HIGH">High</option>
                                    <option style="color: blue; font-weight: bold;" value="MEDIUM">Medium</option>
                                    <option style="color: green; font-weight: bold;" value="LOW">Low</option>
                                </select>

                                <button class="btn btn-default" style="margin-left: 15px;" type="button" on-click="onClearQuery">
                                    <i class="fa fa-times fa-lg" aria-hidden="true"></i>
                                </button>

                                <button class="btn btn-default" type="button" on-click="updateQuery">
                                    <i class="fa fa-search fa-lg" aria-hidden="true"></i>
                                </button>


                                <!--<template is="dom-if" if="{{showSelectFilters(opencgaClient._config)}}">-->
                                    <div class="btn-group" style="float: right">
                                        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <i class="fa fa-filter" aria-hidden="true" style="padding-right: 5px"></i> Filters <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-right">
                                            <li><a style="font-weight: bold">Saved Filters</a></li>
                                            <template is="dom-repeat" items="{{filters}}">
                                                <li>
                                                    <template is="dom-if" if="{{!item.active}}">
                                                        <a data-filter-name$="{{item.name}}" style="cursor: pointer" on-click="onServerFilterChange" class="filtersLink">&nbsp;&nbsp;{{item.name}}</a>
                                                    </template>
                                                    <template is="dom-if" if="{{item.active}}">
                                                        <a data-filter-name$="{{item.name}}" style="cursor: pointer;color: green" on-click="onServerFilterChange" class="filtersLink">&nbsp;&nbsp;{{item.name}}</a>
                                                    </template>
                                                </li>
                                            </template>
                                            <template is="dom-if" if="{{checkSid(opencgaClient._config)}}">
                                                <li role="separator" class="divider"></li>
                                                <li>
                                                    <a style="cursor: pointer" on-click="launchModal"><i class="fa fa-floppy-o" aria-hidden="true"></i> Save...</a>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                <!--</template>-->

                            </div>
                        </div>
                    </div>

                    <opencga-clinical-analysis-grid opencga-session="{{opencgaSession}}" config="[[_config.grid]]"
                                                    search="{{search}}" style="font-size: 12px"
                                                    on-selectanalysis="onSelectClinicalAnalysis"
                                                    active>
                    </opencga-clinical-analysis-grid>
                </div>
            </div>
        </div>

    </template>

    <script>
        class OpencgaClinicalAnalysisPortal extends Polymer.Element {

            constructor() {
                super();
                this.prefix = "ocap-" + Utils.randomString(6);
            }

            static get is() {
                return 'opencga-clinical-analysis-portal';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object
                    },
                    search: {
                        type: Object,
                        notify: true
                    },
                    config: {
                        type: Object,
                        observer: "configObserver"
                    }
                }
            }

            static get observers() {
                return ['propertyObserver(opencgaSession, config)'];
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            connectedCallback() {
                super.connectedCallback();
                this.search = {};

                this.proband = "Any";
                this.family = "Any";
                this.case = "Any";
            }

            propertyObserver(opencgaSession, config) {
                this._config = Object.assign(this.getDefaultConfig(), this.config);
            }

            onProbandInput(e) {
                let buttonElem = e.target.parentElement.parentElement.parentElement.previousSibling.previousElementSibling;

                if (UtilsNew.isNotEmpty(e.target.value)) {
                    this.proband = e.target.value;
                    buttonElem.style.color = "#333";
                } else {
                    this.proband = "Any";
                    buttonElem.style.color = "rgb(153, 153, 153)";
                }
            }

            onFamilyInput(e) {
                let buttonElem = e.target.parentElement.parentElement.parentElement.previousSibling.previousElementSibling;

                if (UtilsNew.isNotEmpty(e.target.value)) {
                    this.family = e.target.value;
                    buttonElem.style.color = "#333";
                } else {
                    this.family = "Any";
                    buttonElem.style.color = "rgb(153, 153, 153)";
                }
            }

            onCaseInput(e) {
                let buttonElem = e.target.parentElement.parentElement.parentElement.previousSibling.previousElementSibling;

                if (UtilsNew.isNotEmpty(e.target.value)) {
                    this.case = e.target.value;
                    buttonElem.style.color = "#333";
                } else {
                    this.case = "Any";
                    buttonElem.style.color = "rgb(153, 153, 153)";
                }
            }

            onClearQuery(e) {
                $(`#${this.prefix}-priority`).selectpicker('val', '');
                $(`#${this.prefix}-status`).selectpicker('val', '');

                // We create a dummy event so the input listeners are called and everything is automatically cleaned up
                let event = new CustomEvent("keyup", {});
                let inputElements = PolymerUtils.querySelectorAll(`.${this.prefix}-input`);
                for (let i = 0; i < inputElements.length; i++) {
                    inputElements[i].value = "";
                    inputElements[i].dispatchEvent(event);
                }

                this.updateQuery();
            }

            updateQuery() {
                let search = {};

                let defaultValue = "Any";

                if (this.case !== defaultValue) {
                    search['id'] = this.case;
                }

                if (this.family !== defaultValue) {
                    search['family'] = this.family;
                }

                if (this.proband !== defaultValue) {
                    search['proband'] = this.proband;
                }

                let priority = $(`#${this.prefix}-priority`).selectpicker('val');
                if (UtilsNew.isNotEmpty(priority)) {
                    search["priority"] = priority.join(",");
                }

                let status = $(`#${this.prefix}-status`).selectpicker('val');
                if (UtilsNew.isNotEmpty(status)) {
                    search["status"] = status.join(",");
                }

                this.search = search;
            }

            getDefaultConfig() {
                return {
                    title: "Clinical Analysis Portal",
                    showTitle: true,
                    grid: {
                        pageSize: 10,
                        pageList: [10, 25, 50],
                        detailView: true,
                        multiSelection: false
                    }
                }
            }
        }

        customElements.define(OpencgaClinicalAnalysisPortal.is, OpencgaClinicalAnalysisPortal);
    </script>
</dom-module>
