<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../../cellbase/variation/cellbase-variantannotation-view.html">
<link rel="import" href="opencga-variant-file-metrics.html">
<link rel="import" href="variant-beacon-network.html">

<dom-module id="opencga-variant-interpretation-detail">
    <template>
        <style include="jso-styles"></style>

        <div style="padding-top: 20px" hidden$="{{!checkVariant(variant)}}">
            <h3>Variant: {{variant.id}}</h3>

            <div style="padding-top: 20px">
                <!-- Dynamically create the Detail Tabs from Browser config -->
                <ul id="{{prefix}}ViewTabs" class="nav nav-tabs" role="tablist">
                    <template is="dom-repeat" items="{{config}}">
                        <template is="dom-if" if="{{item.active}}">
                            <li role="presentation" class="active">
                                <a href="#{{prefix}}{{item.id}}" role="tab" data-toggle="tab" data-id$="{{item.id}}"
                                   class="browser-variant-tab-title" on-click="_changeBottomTab">{{item.title}}</a>
                            </li>
                        </template>

                        <template is="dom-if" if="{{!item.active}}">
                            <li role="presentation" class="">
                                <a href="#{{prefix}}{{item.id}}" role="tab" data-toggle="tab" data-id$="{{item.id}}"
                                   class="browser-variant-tab-title" on-click="_changeBottomTab">{{item.title}}</a>
                            </li>
                        </template>
                    </template>
                </ul>

                <div class="tab-content" style="height: 680px">
                    <!-- Annotation Tab -->
                    <div id="{{prefix}}annotation" role="tabpanel" class="tab-pane active">
                        <div style="width: 75%;padding-top: 8px">
                            <cellbase-variantannotation-view data="{{_variantId}}" assembly={{opencgaSession.project.organism.assembly}} prefix="{{prefix}}"
                                                             cellbase-client="{{cellbaseClient}}" mode="vertical"
                                                             consequence-types="{{consequenceTypes}}"
                                                             protein-substitution-scores="{{proteinSubstitutionScores}}"
                                                             style="font-size: 12px">
                            </cellbase-variantannotation-view>
                        </div>
                    </div>

                    <!-- Cohort Stats Tab -->
                    <div id="{{prefix}}fileMetrics" role="tabpanel" class="tab-pane">
                        <div style="width: 75%;padding-top: 8px">
                            <opencga-variant-file-metrics opencga-session="{{opencgaSession}}"
                                                          variant="{{variant}}"
                                                          clinicalAnalysis={{clinicalAnalysis}}
                            </opencga-variant-file-metrics>
                        </div>
                    </div>

                    <!-- Cohort Stats Tab -->
                    <div id="{{prefix}}cohortStats" role="tabpanel" class="tab-pane">
                        <div style="width: 75%;padding-top: 8px">
                            <opencga-variant-cohort-stats opencga-session="{{opencgaSession}}"
                                                          variant="{{variant.id}}"
                                                          active="{{detailActiveTabs.cohortStats}}">
                            </opencga-variant-cohort-stats>
                        </div>
                    </div>

                    <!-- Samples Tab -->
                    <div id="{{prefix}}samples" role="tabpanel" class="tab-pane">
                        <div style="width: 75%;padding-top: 8px">
                            <opencga-variant-samples opencga-session="{{opencgaSession}}"
                                                     variant="{{variant.id}}"
                                                     active="{{detailActiveTabs.samples}}">
                            </opencga-variant-samples>
                        </div>
                    </div>

                    <!-- Beacon Network Tab-->
                    <div id="{{prefix}}beacon" role="tabpanel" class="tab-pane">
                        <div style="width: 75%;padding-top: 8px">
                            <variant-beacon-network variant="{{variant.id}}" clear="{{variant.id}}" config="{{beaconConfig}}"></variant-beacon-network>
                        </div>
                    </div>

                    <!-- Example Template Tab-->
                    <div id="{{prefix}}template" role="tabpanel" class="tab-pane">
                        <div style="width: 75%;padding-top: 8px">
                            <opencga-variant-detail-template opencga-session="{{opencgaSession}}"
                                                             variant="{{variant.id}}"
                                                             active="{{detailActiveTabs.template}}">
                            </opencga-variant-detail-template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </template>

    <script>
        class OpencgaVariantInterpretationDetail extends Polymer.Element {

            constructor() {
                super();

                // Set status and init private properties
                this._init();
            }

            static get is() {
                return 'opencga-variant-interpretation-detail'
            };

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object
                    },
                    cellbaseClient: {
                        type: Object
                    },
                    clinicalAnalysis: {
                        type: Object,
                    },
                    variant: {
                        type: Object,
                    },
                    consequenceTypes: {
                        type: Object
                    },
                    proteinSubstitutionScores: {
                        type: Object
                    },
                    config: {
                        type: Object,
                    }
                }
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            static get observers() {
                return [
                    "propertyObserver(opencgaSession, variant, config)"
                ];
            }

            /**
             * Init the variables you need, keep in mind this is executed before the actual Polymer properties exist
             */
            _init() {
                // All id fields in the template must start with prefix, this allows components to be instantiated more than once
                this.prefix = "oivd" + Utils.randomString(6);

                // Initially we set the default config, this will be overridden if 'config' is passed
                this._config = this.getDefaultConfig();
            }

            propertyObserver(opencgaSession, variant, config) {
                // With each property change we must updated config and create the columns again. No extra checks are needed.
                this._config = Object.assign(this.getDefaultConfig(), config);

                if (UtilsNew.isNotEmpty(variant)) {
                    this._variantId = `${variant.chromosome}:${variant.start}:${variant.reference}:${variant.alternate}`;
                }
            }

            checkVariant(variant) {
                if (UtilsNew.isNotUndefinedOrNull(variant)) {
                    return variant.id.startsWith("rs") || variant.id.split(':').length > 2;
                } else {
                    return false;
                }
            }

            _changeBottomTab(e) {
                let _activeTabs = {};
                for (let detail of this.config) {
                    _activeTabs[detail.id] = (detail.id === e.currentTarget.dataset.id);
                }
                this.set("detailActiveTabs", _activeTabs);
            }

            getDefaultConfig() {
                return {

                };
            }
        }

        customElements.define(OpencgaVariantInterpretationDetail.is, OpencgaVariantInterpretationDetail);
    </script>
</dom-module>