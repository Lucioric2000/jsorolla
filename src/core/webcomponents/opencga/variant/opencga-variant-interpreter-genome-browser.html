<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<link rel="import" href="../../../../genome-browser/webcomponent/genome-browser.html">
<link rel="import" href="../catalog/samples/opencga-sample-browser.html">

<dom-module id="opencga-variant-interpreter-genome-browser">
    <template>
        <style include="jso-styles">
            .form-section-title {
                padding: 5px 0px;
                width: 80%;
                border-bottom-width: 1px;
                border-bottom-style: solid;
                border-bottom-color: #ddd
            }

            .jso-label-title {
                width: 15em !important;
            }
        </style>

        <template is="dom-if" if="{{_config.showTitle}}">
            <div class="panel" style="margin-bottom: 15px">
                <h3 style="margin: 10px 10px 10px 15px">
                    <i class="fa fa-list" aria-hidden="true"></i> &nbsp;{{_config.title}}
                </h3>
            </div>
        </template>

        <div class="row " style="padding: 0px 10px; margin: 10px 0px;">
            <div class="col-md-12">

                <div style="display: block; cursor:pointer;" on-click="toggleCollapsedFilter"
                     data-toggle="collapse" href$="#{{prefix}}collapsibleFilter">
                    <h3 class="form-section-title">
                    <template is="dom-if" if="{{_filtersCollapsed}}">
                        <i class="fa fa-caret-right" aria-hidden="true" style="padding-right: 5px"></i>
                    </template>
                    <template is="dom-if" if="{{!_filtersCollapsed}}">
                        <i class="fa fa-caret-down" aria-hidden="true" style="padding-right: 5px"></i>
                    </template>
                    Genome Browser Filters</h3>
                </div>

                <div id="{{prefix}}collapsibleFilter" class="form-horizontal collapse in">

                    <div class="form-group">
                        <label class="control-label col-md-1 jso-label-title">Search by Region</label>
                        <div class="input-group col-md-3" style="padding-left: 15px;padding-right: 15px">
                            <input id="{{prefix}}RegionInputText" type="text" class="form-control" placeholder="e.g. 3:55555-666666">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button" on-click="onEraserClicked">
                                    <i class="fa fa-eraser" aria-hidden="true"></i>
                                </button>
                            </span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label col-md-1 jso-label-title">Search by Gene</label>
                        <div class="col-md-3">
                            <cellbase-gene-filter cellbase-client="{{cellbaseClient}}"
                                                  erase="{{eraseSearchGene}}"
                                                  on-genechange="onInputGeneChange">
                            </cellbase-gene-filter>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label col-md-1 jso-label-title">Select a Gene from Panel</label>
                        <div class="col-md-3">
                            <select class="selectpicker" id="{{prefix}}-geneSelect" data-live-search="true" data-max-options="1"
                                    on-dom-change="renderDomRepeat" multiple>
                                <optgroup label="Selected Genes">
                                    <template is="dom-repeat" items="{{geneIds}}" as="geneId">
                                        <option>{{geneId}}</option>
                                    </template>
                                </optgroup>

                                <template is="dom-repeat" items="{{_genePanels}}" as="panel">
                                    <optgroup label="{{panel.name}}">
                                        <template is="dom-repeat" items="{{panel.genes}}" as="gene">
                                            <option>{{gene.name}}</option>
                                        </template>
                                    </optgroup>
                                </template>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label col-md-1 jso-label-title">Show Alignments (BAM)</label>
                        <div class="col-md-3">
                            <input type="checkbox">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-md-offset-3 col-md-9">
                            <button type="submit" class="btn btn-primary" on-click="onClear">Clear</button>
                            <button type="submit" class="btn btn-primary" on-click="showSelectionInGenomeBrowser">Render</button>
                        </div>
                    </div>
                </div>

                <!--<div class="col-md-6" style="margin-top: 15px;">-->
                <!--<button id="{{prefix}}RunGenomeBrowser" type="button" class="btn btn-primary"-->
                <!--on-click="showSelectionInGenomeBrowser" style="float: right">-->
                <!--Show Genome Browser-->
                <!--</button>-->
                <!--</div>-->
            </div>


            <!-- Genome browser -->
            <div class="col-md-12">
                <h3 class="form-section-title">Genome Browser</h3>

                <!--<div style$="padding: 20px 0px;display: {{displayGenomeBrowserMessage}};">-->
                    <!--<div style="padding: 20px">-->
                        <!--<span style="font-weight: bolder">Please select some data above</span>-->
                    <!--</div>-->
                <!--</div>-->

                <div style="padding: 20px">
                    <genome-browser id="{{prefix}}gb" opencga-session={{opencgaSession}} cellbase-client="{{cellbaseClient}}"
                                    opencga-client="{{opencgaSession.opencgaClient}}" region="{{genomeBrowserRegion}}" tracks="{{tracks}}">
                    </genome-browser>
                </div>
            </div>
        </div>

    </template>

    <script>
        class OpencgaVariantInterpreterGenomeBrowser extends Polymer.Element {

            static get is() {
                return 'opencga-variant-interpreter-genome-browser';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object,
                        observer: "onStudyUpdate"
                    },
                    cellbaseClient: {
                        type: Object
//                        observer: "init"
                    },
                    clinicalAnalysisId: {
                        type: String,
                        observer: "clinicalAnalysisIdObserver"
                    },
                    clinicalAnalysis: {
                        type: Object
                    },
                    // samples: {
                    //     type: Array,
                    //     observer: "samplesObserver"
                    // },
                    region: {
                        type: String,
                        observer: "regionObserver"
                    },
                    geneIds: {
                        type: Array
                    },
                    panelIds: {
                        type: Array
                    },
                    active: {
                        type: Boolean,
                        value: false,
                        observer: "_setActive"
                    },
                    config: {
                        type: Object
                    }
                }
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            static get observers() {
                return ['propertyObserver(opencgaSession, clinicalAnalysis, panelIds, geneIds, config)'];
            }

            constructor() {
                super();

                // Set status and init private properties
                this._init();
            }

            _init() {
                this.prefix = "OpencgaVariantInterpreterGenomeBrowser" + Utils.randomString(6);

                this._availableFiles = [];
                if (!UtilsNew.isNotUndefinedOrNull(this.region)) {
                    this.region = new Region({chromosome: "11", start: 68177378, end: 68177510});
                }

                this.tracks = {
                    sequence: {type: "sequence"},
                    gene: {type: "gene"},
                    variant: {type: "variant", config: {}},
                    alignment: {type: "alignment", config: {}}
                };

                this._filtersCollapsed = false;

                this.displayGenomeBrowserMessage = "inline";

                this._config = this.getDefaultConfig();
            }

            propertyObserver(opencgaSession, clinicalAnalysis, panelIds, geneIds, config) {
                this._config = Object.assign(this.getDefaultConfig(), config);

                if (UtilsNew.isNotUndefinedOrNull(this.opencgaSession)) {
                    let _this = this;
                    if (UtilsNew.isNotEmptyArray(this.panelIds)) {
                        this.opencgaSession.opencgaClient.panels().info(panelIds.join(","),
                            {
                                study: _this.opencgaSession.study.fqn,
                                include: "id,name,genes"
                            })
                            .then(function (response) {
                                // _this._panelGenesAvailable = true;
                                let _panels = [];
                                for (let panel of response.response) {
                                    _panels.push(panel.result[0]);
                                }
                                _this._genePanels = _panels;
                            })
                            .catch((response) => {
                                console.error("An error occurred fetching clinicalAnalysis: ", response)
                            });
                    } else {
                        this._genePanels = [];
                    }
                }
            }

            /**
             * Fetch the CinicalAnalysis object from REST and trigger the observer call.
             */
            clinicalAnalysisIdObserver() {
                if (UtilsNew.isNotUndefinedOrNull(this.opencgaSession) && UtilsNew.isNotEmpty(this.clinicalAnalysisId)) {
                    let _this = this;
                    this.opencgaSession.opencgaClient.clinical().info(clinicalAnalysis, {study: this.opencgaSession.study.fqn})
                        .then(function(response) {
                            // This will trigger the call clinicalAnalysis observer
                            _this.clinicalAnalysis = response.response[0].result[0];
                        })
                        .catch((response) => {
                            console.error("An error occurred fetching clinicalAnalysis: ", response)
                        });
                }
            }

            renderDomRepeat(e) {
                $(`#${this.prefix}-geneSelect`).selectpicker('refresh');
                $(`#${this.prefix}-geneSelect`).selectpicker('deselectAll');
            }

            toggleCollapsedFilter() {
                this.set("_filtersCollapsed", !this._filtersCollapsed);
            }

            regionObserver() {
                this.genomeBrowserRegion = new Region(this.region);
            }

            onStudyUpdate() {
                if (UtilsNew.isNotUndefinedOrNull(this.opencgaSession) && UtilsNew.isNotUndefinedOrNull(this.opencgaSession.study)) {
                    this._availableFiles = [];
                    // this.showSelectionInGenomeBrowser();
                }
            }

            showSelectionInGenomeBrowser() {
                let region = PolymerUtils.getValue(this.prefix + "RegionInputText");
                if (UtilsNew.isNotEmpty(region)) {
                    this.genomeBrowserRegion = new Region(region);
                }

                let genomeBrowser = PolymerUtils.getElementById(this.prefix  + "gb");

                if (genomeBrowser !== undefined && genomeBrowser !== null) {
                    let inputArray = document.querySelectorAll('input[name=' + this.prefix + 'file-checkbox]:checked');

                    let myVariantFiles = [];
                    let myAlignmentFiles = [];
                    inputArray.forEach(function(input) {
                        let file = input.data;
                        if (file.format === "VCF") {
                            myVariantFiles.push(file);
                        } else if (file.format === "BAM") {
                            myAlignmentFiles.push(file);
                        }
                    });

                    // In order to notify of the changes to the genome browser, we make a copy of the tracks object
                    let _tracks = this.tracks;
                    _tracks.variant.config.files = myVariantFiles;
                    _tracks.alignment.config.files = myAlignmentFiles;
                    this.tracks = Object.assign({}, _tracks);

                    // Activate genome browser
                    // if (myVariantFiles.length > 0 || myAlignmentFiles.length > 0) {
                    // Hide Genome Browser initial message
                    this.displayGenomeBrowserMessage = "none";
                    genomeBrowser.active = true;
                    // }
                }
            }

            // showSampleBrowser(e) {
            //     e.preventDefault();
            //
            //     this.sampleBrowserModal = UtilsNew.isUndefined(this.sampleBrowserModal) ? true : !this.sampleBrowserModal;
            //     $("#" + this.prefix + "SampleBrowser").modal('show');
            // }

            // samplesObserver() {
            //     for (let sample of this.samples) {
            //         this._addSample(sample.name);
            //     }
            // }

            // addSample(e) {
            //     let sample = PolymerUtils.getElementById(this.prefix  + "AutocompleteSearchInput").value;
            //     this._addSample(sample);
            // }

            // _addSample(sample) {
            //     for (let i in this._availableFiles) {
            //         let existingSample = this._availableFiles[i].name;
            //         if (existingSample === sample) {
            //             // The sample is already in the shown list
            //             return;
            //         }
            //     }
            //
            //     let queryParams = {
            //         study: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias,
            //         sample: sample,
            //         format: "VCF,BAM",
            //         include: "path,name,format,bioformat",
            //     };
            //
            //     let _this = this;
            //     this.opencgaSession.opencgaClient.files().search(queryParams)
            //         .then(values => {
            //             if (values.response[0].result !== undefined && values.response[0].result.length > 0) {
            //                 _this.push("_availableFiles", {
            //                     name: sample,
            //                     files: values.response[0].result
            //                 });
            //             }
            //         })
            //         .catch(function (response) {
            //             _this.showErrorAlert(response.error);
            //         });
            // }

            // deleteSample(e) {
            //     let sample = e.currentTarget.dataSample;
            //
            //     // We make a copy of the list of available files excluding the selected sample
            //     let availableFiles = [];
            //     for (let i in this._availableFiles) {
            //         let item = this._availableFiles[i];
            //         if (item.name !== sample) {
            //             availableFiles.push(item);
            //         }
            //     }
            //
            //     this._availableFiles = availableFiles;
            // }

//             _autocompleteSampleSearch(e) {
//                 // Only gene symbols are going to be searched and not Ensembl IDs
//                 let sampleNamePrefix = PolymerUtils.getElementById(this.prefix  + "AutocompleteSearchInput").value;
//                 if (UtilsNew.isNotUndefinedOrNull(sampleNamePrefix) && sampleNamePrefix.length >= 4) {
//                     let _this = this;
//                     this.opencgaSession.opencgaClient.samples()
//                         .search({
//                             study: _this.opencgaSession.project.alias + ":" + _this.opencgaSession.study.alias,
//                             name: "~^" + sampleNamePrefix,
//                             include: "id,name",
//                             includeIndividual: false,
//                             limit: 20}, {})
//                         .then(function (response) {
// //                            _this.autocompleteSampleData = response.response[0].result;
//                             let options = "";
//                             for (let sample of response.response[0].result) {
//                                 let sampleStr = JSON.stringify(sample);
//                                 options += `<option id="${_this.prefix}Sample${sample.name}" value="${sample.name}" data-sample='` + sampleStr + "'>";
//                             }
//                             PolymerUtils.innerHTML(_this.prefix + "AutocompleteSearchDataList", options);
//                         });
//                 }
//             }



            getDefaultConfig() {
                return {
                    title: "Genome Browser",
                    showTitle: true
                };
            }
        }

        customElements.define(OpencgaVariantInterpreterGenomeBrowser.is, OpencgaVariantInterpreterGenomeBrowser);
    </script>
</dom-module>
