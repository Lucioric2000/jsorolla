  <!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<dom-module id="opencga-interpreted-variant-grid">
    <template>
        <style include="jso-styles">
            .variant-link-dropdown:hover .dropdown-menu {
                display: block;
            }

            .detail-view :hover {
                background-color: white;
            }

            .detail-view-row :hover {
                background-color: #f5f5f5;
            }

            .qtip-custom-class .qtip-content{
                font-size: 12px;
            }
        </style>


        <opencb-grid-toolbar from="{{from}}" to="{{to}}" num-total-results-text="{{numTotalResultsText}}"
                             config="{{toolbarConfig}}" on-columnchange="onColumnChange" on-download="onDownload" on-sharelink="onShare">
        </opencb-grid-toolbar>

        <!--{{clinicalAnalysis.description}}-->
        <div id="{{prefix}}GridTableDiv" style="margin-top: 10px">
            <table id="{{prefix}}VariantBrowserGrid">
                <thead style="background-color: #eee"></thead>
            </table>
        </div>
    </template>

    <script>
        class OpencgaInterpretedVariantGrid extends Polymer.Element {

            constructor() {
                super();

                // Set status and init private properties
                this._init();
            }

            static get is() {
                return 'opencga-interpreted-variant-grid';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object,
                    },
                    clinicalAnalysis: {
                        type: Object,
                    },
                    query: {
                        type: Object,
                    },
                    reportedVariants: {
                        type: Array,
                        observer: 'renderFromLocal'
                    },
                    consequenceTypes: {
                        type: Object,
                    },
                    populationFrequencies: {
                        type: Object
                    },
                    proteinSubstitutionScores: {
                        type: Object,
                    },
                    config: {
                        type: Object
                    }
                }
            }

            static get observers() {
                return [
                    "propertyObserver(opencgaSession, clinicalAnalysis, query, consequenceTypes, populationFrequencies, proteinSubstitutionScores, config)"
                ];
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            connectedCallback() {
                super.connectedCallback();

                // TODO Refactor
                this.downloadRefreshIcon = $("#" + this.prefix + "DownloadRefresh");
                this.downloadIcon = $("#" + this.prefix + "DownloadIcon");

                this._columns = this._createDefaultColumns();
                if (UtilsNew.isUndefinedOrNull(this.reportedVariants)) {
                    this.renderVariantTable();
                } else {
                    this.renderFromLocal();
                }
            }

            _init() {
                this.prefix = "VarBrowserGrid-" + Utils.randomString(6);

                this.query = {};
                this._config = this.getDefaultConfig();
            }

            propertyObserver(opencgaSession, clinicalAnalysis, query, consequenceTypes, populationFrequencies, proteinSubstitutionScores, config) {
                // With each property change we must updated config and create the columns again. No extra checks are needed.
                this._config = Object.assign(this.getDefaultConfig(), config);

                let _individuals = [];
                let _samples = [];
                if (UtilsNew.isNotUndefinedOrNull(clinicalAnalysis)) {
                    // let _individuals = [];
                    if (UtilsNew.isNotUndefinedOrNull(clinicalAnalysis.family) && UtilsNew.isNotUndefinedOrNull(clinicalAnalysis.family.members)) {
                        _individuals = clinicalAnalysis.family.members;
                    } else {
                        if (UtilsNew.isNotUndefinedOrNull(clinicalAnalysis.proband)) {
                            _individuals = [clinicalAnalysis.proband];
                        }
                    }

                    for (let individual of _individuals) {
                        _samples.push(individual.samples[0]);
                    }
                }
                this.samples = _samples;
                this.individuals = _individuals;


                // Config for the grid toolbar
                this.toolbarConfig = {
                    columns: [
                        {
                            title: 'Variant', field: "id",
                        },
                        {
                            title: 'Genes', field: "genes",
                        },
                        {
                            title: 'Type', field: "type",
                        },
                        {
                            title: 'Gene Annotations', field: "consequenceType",
                        }
                    ]
                };


                this._columns = this._createDefaultColumns();
                this.variantGridFormatter = new VariantGridFormatter(this.opencgaSession, this._config);

                // Set colors
                let colors = this.variantGridFormatter.assignColors(this.consequenceTypes, this.proteinSubstitutionScores);
                Object.assign(this, colors);

                if (UtilsNew.isUndefinedOrNull(this.reportedVariants)) {
                    this.renderVariantTable();
                } else {
                    this.renderFromLocal();
                }
            }

            onColumnChange(e) {
                let table = $('#' + this.prefix + 'VariantBrowserGrid');
                if (e.detail.selected) {
                    table.bootstrapTable("showColumn", e.detail.id);
                } else {
                    table.bootstrapTable("hideColumn", e.detail.id);
                }
            }

            renderVariantTable() {
                this.from = 1;
                this.to = 10;
                this.approximateCountResult = false;

                let _table = $('#' + this.prefix + 'VariantBrowserGrid');

                if (typeof this.opencgaSession !== "undefined" && typeof this.opencgaSession.project !== "undefined"
                    && typeof this.opencgaSession.study !== "undefined" && typeof this.opencgaSession.study.alias !== "undefined"
                    && UtilsNew.isNotEmpty(this.query)) {

                    let urlQueryParams = this._getUrlQueryParams();
                    let queryParams = urlQueryParams.queryParams;
                    let _numTotal = -1;
                    let _this = this;
                    $('#' + this.prefix + 'VariantBrowserGrid').bootstrapTable('destroy');
                    $('#' + this.prefix + 'VariantBrowserGrid').bootstrapTable({
                        url: urlQueryParams.host,
                        columns: _this._columns,
                        method: 'get',
                        sidePagination: 'server',

                        // Set table properties, these are read from config property
                        uniqueId: "id",
                        pagination: _this._config.pagination,
                        pageSize: _this._config.pageSize,
                        pageList: _this._config.pageList,
                        showExport: _this._config.showExport,
                        detailView: _this._config.detailView,
                        detailFormatter: _this._config.detailFormatter,

                        // this makes the opencga-interpreted-variant-grid properties available in the bootstrap-table formatters
                        variantGrid: _this,

                        queryParams: function (params) {
                            queryParams.limit = params.limit;
                            queryParams.skip = params.offset;
                            return queryParams;
                        },
                        responseHandler: function (resp) {
                            if (_numTotal === -1) {
                                _numTotal = resp.response[0].numTotalResults;
                            }
                            // Format the number string with commas
                            _this.to = Math.min(resp.response[0].numResults, this.pageSize);
                            _this.numTotalResultsText = _numTotal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                            _this.approximateCountResult = resp.response[0].approximateCount;
                            return {total: _numTotal, rows: resp.response[0].result.primaryFindings}
                        },
                        onClickRow: function (row, $element, field) {
                            $("#" + _this.prefix + "VariantBrowserGrid tr").removeClass('success');
                            $($element).addClass('success');

                            _this._onSelectVariant(row);
                        },
                        onCheck: function (row, $element) {
                            let _variant = row.chromosome + ":" + row.start + ":" + row.reference + ":" + row.alternate;
                            _this.dispatchEvent(new CustomEvent('checkvariant', {
                                detail: {
                                    id: _variant,
                                    variant: row,
                                    checkdVariant: true,
                                    variants: $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable('getAllSelections'),
                                }
                            }));
                        },
                        onCheckAll: function (rows) {
                            _this.dispatchEvent(new CustomEvent('checkvariant', {
                                detail: {
                                    variants: $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable('getAllSelections'),
                                }
                            }));
                        },
                        onUncheck: function (row, $element) {
                            let _variant = row.chromosome + ":" + row.start + ":" + row.reference + ":" + row.alternate;
                            _this.dispatchEvent(new CustomEvent('checkvariant', {
                                detail: {
                                    id: _variant,
                                    variant: row,
                                    checkdVariant: false,
                                    variants: $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable('getAllSelections'),
                                }
                            }));
                        },
                        onLoadSuccess: function (data) {
                            // The first time we mark as selected the first row that is rows[2] since the first two rows are the header
                            if (UtilsNew.isNotEmptyArray(data.rows) && UtilsNew.isNotUndefinedOrNull(_table)) {
                                PolymerUtils.querySelector(_table.selector).rows[2].setAttribute('class', 'success');
                                _this._onSelectVariant(data.rows[0]);

                                let elementsByClassName = PolymerUtils.getElementsByClassName("genome-browser-option");
                                for (let elem of elementsByClassName) {
                                    elem.addEventListener('click', function(e) {
                                        // _this.genomeBrowserPosition = e.target.dataset.variantPosition;
                                        _this.dispatchEvent(new CustomEvent('setgenomebrowserposition', {
                                            detail: {
                                                genomeBrowserPosition: e.target.dataset.variantPosition,
                                            }, bubbles: true, composed: true
                                        }));
                                    });
                                }
                            }
                        },
                        onLoadError: function (status, res) {
                            debugger
                        },
                        onPageChange: function (page, size) {
                            _this.from = (page - 1) * size + 1;
                            _this.to = page * size;
                        },
                        onPostBody: function (data) {
                            // Add tooltips
                            _this.variantGridFormatter.addTooltip("div.zygositySampleTooltip", "File metrics", {style: {classes: "qtip-rounded qtip-shadow qtip-custom-class"}});
                            _this.variantGridFormatter.addTooltip("div.variant-tooltip", "Links");
                            _this.variantGridFormatter.addTooltip("span.gene-tooltip", "Links");
                            _this.variantGridFormatter.addPopulationFrequenciesTooltip("table.populationFrequenciesTable", _this.populationFrequencies);
                            _this.variantGridFormatter.addPopulationFrequenciesInfoTooltip("popFreqInfoIcon", _this.populationFrequencies);
                        }
                    });

                    // if (!this.showSelect) {
                    //     $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable('hideColumn', "selectForInterpretation");
                    //     $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable('hideColumn', "stateCheckBox");
                    // }

                    $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable('showLoading');
                }
            }

            _getUrlQueryParams() {
                // Check the opencgaClient exists
                if (UtilsNew.isUndefinedOrNull(this.opencgaSession.opencgaClient)) {
                    return {host: "", queryParams: {}};
                }

                // Prepare host. By default we assume https protocol instead of http
                let host = this.opencgaSession.opencgaClient.getConfig().host;
                if (!host.startsWith("https://") && !host.startsWith("http://")) {
                    host += "https://";
                }

                if (typeof this.opencgaSession.project !== "undefined" && typeof this.opencgaSession.study.alias !== "undefined") {
                    // if (typeof this.query === "undefined") {
                    //     this.query = {};
                    // }     || this.query.study.split(new RegExp("[,;]")).length === 1
                    if (UtilsNew.isEmpty(this.query.study) ) {
                        this.query.study = this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias;
                    }
                    // host += '/webservices/rest/v1/analysis/variant/query';
                    host += '/webservices/rest/v1/analysis/clinical/interpretation/tools/custom';
                } else {
                    return {host: host, queryParams: {}};
                }


                // Init queryParams with default and config values plus query object
                let queryParams;
                if (UtilsNew.isNotUndefinedOrNull(this.config) && UtilsNew.isNotUndefinedOrNull(this.config.grid)
                    && UtilsNew.isNotUndefinedOrNull(this.config.grid.queryParams)) {
                    queryParams = Object.assign({}, this.config.grid.queryParams, this.query);
                } else {
                    queryParams = Object.assign({}, this.query);
                }

                if (this.opencgaSession.opencgaClient._config.sessionId !== undefined) {
                    queryParams = Object.assign(queryParams, {sid: this.opencgaSession.opencgaClient._config.sessionId});
                }

                if (UtilsNew.isNotEmptyArray(this.samples)) {
                    // Filters sample and genotype are exclusive
                    if (UtilsNew.isUndefinedOrNull(queryParams.genotype)) {
                        let sampleIds = [];
                        this.samples.forEach((sample) => {
                            sampleIds.push(sample.id);
                        });
                        queryParams.sample = sampleIds.join(";");
                        // queryParams.includeSample = sampleIds.join(",");
                    }

                    queryParams.summary = false;
                    queryParams.exclude = "annotation.geneExpression";
                    queryParams.approximateCount = true;
                    queryParams.useSearchIndex = "yes";
                    queryParams.unknownGenotype = "0/0";
                } else {
                    queryParams.summary = true;
                    // queryParams.exclude = "annotation.geneExpression";
                }

                if (typeof this.config !== "undefined" && UtilsNew.isNotUndefinedOrNull(this.config.grid)
                    && typeof this.config.grid.includeMissing !== "undefined" && this.config.grid.includeMissing) {
                    let keys = Object.keys(queryParams);
                    for (let i = 0; i < keys.length; i++) {
                        let val = queryParams[keys[i]];
                        if (typeof val === "string") {
                            val = val.replace(/</g, "<<");
                            val = val.replace(/>/g, ">>");
                            queryParams[keys[i]] = val;
                        }
                    }
                }

                return {host: host, queryParams: queryParams};
            }

            _onSelectVariant(row) {
                if (typeof row !== "undefined") {
                    let _variant = row.chromosome + ":" + row.start + ":" + row.reference + ":" + row.alternate;
                    this.dispatchEvent(new CustomEvent('selectvariant', {detail: {id: _variant, variant: row}}));
                }
            }

            renderFromLocal() {
                this.from = 1;
                this.to = Math.min(this.reportedVariants.length, this._config.pageSize);
                this.numTotalResultsText = this.reportedVariants.length.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

                let _table = $('#' + this.prefix + 'VariantBrowserGrid');
                let _this = this;
                $('#' + this.prefix + 'VariantBrowserGrid').bootstrapTable('destroy');
                $('#' + this.prefix + 'VariantBrowserGrid').bootstrapTable({
                    data: _this.reportedVariants,
                    columns: _this._columns,
                    sidePagination: 'local',

                    // Set table properties, these are read from config property
                    uniqueId: "id",
                    pagination: _this._config.pagination,
                    pageSize: _this._config.pageSize,
                    pageList: _this._config.pageList,
                    showExport: _this._config.showExport,
                    detailView: _this._config.detailView,
                    detailFormatter: _this._config.detailFormatter,

                    // this makes the opencga-interpreted-variant-grid properties available in the bootstrap-table formatters
                    variantGrid: _this,

                    onClickRow: function (row, $element) {
                        $("#" + _this.prefix + "VariantBrowserGrid tr").removeClass('success');
                        $($element).addClass('success');

                        _this._onClickSelectedVariant(row);
                    },
                    onPageChange: function (page, size) {
                        _this.from = (page - 1) * size + 1;
                        _this.to = page * size;
                    },
                    onPostBody: function (data) {
                        // The first time we mark as selected the first row that is rows[2] since the first two rows are the header
                        if (UtilsNew.isNotEmptyArray(data) && UtilsNew.isNotUndefinedOrNull(_table)) {
                            PolymerUtils.querySelector(_table.selector).rows[2].setAttribute('class', 'success');
                            _this._onClickSelectedVariant(data[0]);
                        }

                        // Add tooltips
                        _this.variantGridFormatter.addTooltip("div.zygositySampleTooltip", "File metrics", {style: {classes: "qtip-rounded qtip-shadow qtip-custom-class"}});
                        _this.variantGridFormatter.addTooltip("div.variant-tooltip", "Links");
                        _this.variantGridFormatter.addTooltip("span.gene-tooltip", "Links");
                        _this.variantGridFormatter.addPopulationFrequenciesTooltip("table.populationFrequenciesTable", _this.populationFrequencies);
                        _this.variantGridFormatter.addPopulationFrequenciesInfoTooltip("popFreqInfoIcon", _this.populationFrequencies);
                    }
                });
            }

            _onClickSelectedVariant(row) {
                if (typeof row !== "undefined") {
                    let _variant = row.chromosome + ":" + row.start + ":" + row.reference + ":" + row.alternate;
                    this.dispatchEvent(new CustomEvent('selectvariant2', {detail: {id: _variant, variant: row}}));
                }
            }

            showGene(geneName) {
                this.dispatchEvent(new CustomEvent('selected', {
                    detail: {
                        gene: geneName
                    }
                }));
            }

            /*
             *  GRID FORMATTERS
             */
            detailFormatter(value, row, a) {
                let result = "<div class='row' style='padding-bottom: 20px'>";
                let detailHtml = "";
                if (typeof row !== "undefined" && typeof row.annotation !== "undefined") {
                    detailHtml = "<div style='padding: 10px 0px 5px 25px'><h4>Reported Events</h4></div>";
                    detailHtml += "<div style='padding: 5px 50px'>";
                    detailHtml += this.variantGrid.variantGridFormatter.reportedEventDetailFormatter(value, row, this.variantGrid);
                    detailHtml += "</div>";

                    detailHtml += "<div style='padding: 25px 0px 5px 25px'><h4>Consequence Types</h4></div>";
                    detailHtml += "<div style='padding: 5px 50px'>";
                    detailHtml += this.variantGrid.variantGridFormatter.consequenceTypeDetailFormatter(value, row, this.variantGrid);
                    detailHtml += "</div>";

                    detailHtml += "<div style='padding: 20px 0px 5px 25px'><h4>Clinical Phenotypes</h4></div>";
                    detailHtml += "<div style='padding: 5px 50px'>";
                    let clinvarTraits = "<div><label style='padding-right: 10px'>ClinVar: </label>-</div>";
                    let cosmicTraits = "<div><label style='padding-right: 10px'>Cosmic: </label>-</div>";
                    if (typeof row.annotation.variantTraitAssociation !== "undefined" && row.annotation.variantTraitAssociation != null) {
                        let traits = {
                            clinvar: [],
                            cosmic: []
                        };
                        let fields = ["clinvar", "cosmic"];
                        for (let field of fields) {
                            let clinicalData = row.annotation.variantTraitAssociation[field];
                            if (UtilsNew.isNotEmptyArray(clinicalData)) {
                                for (let j = 0; j < clinicalData.length; j++) {
                                    if (field === "clinvar" && traits.clinvar.indexOf(clinicalData[j].traits[0]) === -1
                                        && clinicalData[j].traits[0] !== "not specified" && clinicalData[j].traits[0] !== "not provided") {
                                        traits.clinvar.push(clinicalData[j].traits[0]);
                                    } else if (field === "cosmic" && traits.cosmic.indexOf(clinicalData[j].primaryHistology) === -1) {
                                        let histologySubtype = (UtilsNew.isNotEmpty(clinicalData[j].histologySubtype)) ? clinicalData[j].histologySubtype : "-";
                                        traits.cosmic.push(clinicalData[j].primaryHistology + " (" + histologySubtype + ")");
                                    }
                                }
                            }
                        }

                        if (traits.clinvar.length > 0) {
                            clinvarTraits = "<div><label style='padding-right: 10px'>ClinVar: </label>" + traits.clinvar.join(", ") + "</div>";
                        }
                        if (traits.cosmic.length > 0) {
                            cosmicTraits = "<div><label style='padding-right: 10px'>Cosmic: </label>" + traits.cosmic.join(", ") + "</div>";
                        }
                    }
                    detailHtml += clinvarTraits + cosmicTraits;
                    detailHtml += "</div>";
                }
                result += detailHtml + "</div>";
                return result;
            }

            variantFormatter(value, row, index) {
                let variantHtmlDiv = this.variantGridFormatter.variantFormatter(value, row, index);
                let snptHtmlAnchor = this.variantGridFormatter.snpFormatter(value, row, index);
                return variantHtmlDiv + "<div style='padding-top: 10px'>" + snptHtmlAnchor + "</div>";
            }

            predictionFormatter(value, row, index) {
                let res = "";
                if (UtilsNew.isNotUndefinedOrNull(row.reportEvents)){
                    row.reportEvents.forEach((reportEvent) => {
                        if (UtilsNew.isNotUndefinedOrNull(reportEvent.prediction)) {
                            res += "<label>" + reportEvent.prediction + "</label>";
                        }
                        if (UtilsNew.isNotUndefinedOrNull(reportEvent.score)) {
                            res += " (<label>" + reportEvent.score + "</label>)";
                        }
                    });
                }
                return res;
            }

            zygosityFormatter(value, row, index) {
                let resultHtml = "";

                if (UtilsNew.isNotEmptyArray(row.studies)) {
                    if (UtilsNew.isNotUndefinedOrNull(row.studies[0].samplesData)
                        && UtilsNew.isNotUndefinedOrNull(row.studies[0].samplesData[this.field.memberIdx])
                        && UtilsNew.isNotUndefinedOrNull(row.studies[0].samplesData[this.field.memberIdx][0])) {

                        // First, get and check info fields QUAL, FILTER; and format fields DP, AD and GQ
                        let qual = "-";
                        let filter = "-";
                        let dp, ad, gq;
                        let mutationColor = "black";
                        let sampleFormat = row.studies[0].samplesData[this.field.memberIdx];
                        // INFO fields
                        for (let file of this.field.clinicalAnalysis.files[this.field.memberName]) {
                            // Find the sample VCF file, if exists
                            if (file.format === "VCF") {
                                for (let studyFile of row.studies[0].files) {
                                    if (studyFile.fileId === file.name) {
                                        qual = Number(studyFile.attributes.QUAL).toFixed(2);
                                        if (qual < this.field.quality.qual) {
                                            mutationColor = "silver";
                                        }

                                        filter = studyFile.attributes.FILTER;
                                        if (filter !== "PASS") {
                                            mutationColor = "silver";
                                        }
                                    }
                                }
                            }
                        }
                        // FORMAT fields
                        for (let formatField in row.studies[0].format) {
                            switch (row.studies[0].format[formatField]) {
                                case "DP":
                                    dp = sampleFormat[formatField];
                                    if (dp < this.field.quality.dp) {
                                        mutationColor = "silver";
                                    }
                                    break;
                                case "AD":
                                    ad = sampleFormat[formatField];
                                    break;
                                case "GQ":
                                    gq = sampleFormat[formatField];
                                    break;
                            }
                        }

                        // Second, prepare the visual representation of genotypes
                        let left, right;
                        let leftRadio = 8;
                        let rightRadio = 8;
                        let genotypeSplitRegExp = new RegExp("[/|]");
                        let sampleGT = row.studies[0].samplesData[this.field.memberIdx][0];
                        if (sampleGT === "0/1" || sampleGT === "1/0") {
                            // If genotype si 0/1 or 1/0 they must be displayed like 0/1 (not phased)
                            left = "white";
                            right = mutationColor;
                        } else {
                            let genotypes = sampleGT.split(genotypeSplitRegExp);
                            switch (genotypes[0]) {
                                case "0":
                                    left = "white";
                                    break;
                                case "1":
                                    left = mutationColor;
                                    break;
                                case ".":
                                    left = "red";
                                    leftRadio = 1;
                                    break;
                            }
                            switch (genotypes[1]) {
                                case "0":
                                    right = "white";
                                    break;
                                case "1":
                                    right = mutationColor;
                                    break;
                                case ".":
                                    right = "red";
                                    rightRadio = 1;
                                    break;
                            }
                        }

                        // Third, prepare the tooltip information
                        let tooltipText = `<div class="col-md-12" style="padding: 0px">
                                            <form class="form-horizontal">
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-5">QUAL</label>
                                                    <div class="col-md-7">${qual}</div>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-5">FILTER</label>
                                                    <div class="col-md-7">${filter}</div>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-5">DP</label>
                                                    <div class="col-md-7">${dp}</div>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-5">AD</label>
                                                    <div class="col-md-7">${ad}</div>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-5">GQ</label>
                                                    <div class="col-md-7">${gq}</div>
                                                </div>
                                            </form>
                                           </div>`;

                        // Last, put everything together and display
                        resultHtml = `<div class='zygositySampleTooltip' data-tooltip-text='${tooltipText}' style="width: 70px" align="center">
                                        <svg viewBox="0 0 70 30" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="20" cy="15" r="${leftRadio}" style="stroke: black;fill: ${left}"/>
                                            <circle cx="50" cy="15" r="${rightRadio}" style="stroke: black;fill: ${right}"/>
                                        </svg>
                                      </div>
                                `;
                    }
                }

                return resultHtml;
            }

            pathogeniticyFormatter(value, row, index) {
                // TODO we must call to PathDB to get the frequency of each variant, next code is just an example
                let val = `<div class="col-md-12" style="padding: 0px">
                                <form class="form-horizontal">
                                    <div class="col-md-12" style="padding: 0px">
                                        <form class="form-horizontal">
                                            <div class="form-group" style="margin: 0px 2px">
                                                <label class="col-md-5">HP:00${Math.floor((Math.random() * 1000) + 1)}</label>
                                                <div class="col-md-7">${Number(Math.random()).toFixed(2)}</div>
                                            </div>
                                             <div class="form-group" style="margin: 0px 2px">
                                                <label class="col-md-5">HP:00${Math.floor((Math.random() * 1000) + 1)}</label>
                                                <div class="col-md-7">${Number(Math.random()).toFixed(2)}</div>
                                             </div>
                                         </form>
                                      </div>
                                </form>
                           </div>`;

                return val;
            }

            /**
             * Create a color table with ALL cohort for all studies.
             * @param value
             * @param row
             * @returns {*}
             */
            studyCohortsFormatter(value, row) {
                if (typeof row !== "undefined" && typeof row.studies !== "undefined") {
                    let cohorts = [];
                    let cohortMap = new Map();
                    for (let study of row.studies) {
                        let arr = study.studyId.split(":");
                        let s = arr[arr.length - 1] + ":ALL";
                        cohorts.push(s);
                        cohortMap.set(s, Number(study.stats["ALL"].altAlleleFreq).toFixed(4));
                    }

                    return this.variantGridFormatter.createPopulationFrequenciesTable(cohorts, cohortMap, this.populationFrequencies.color);
                } else {
                    return "-";
                }
            }

            clinicalPopulationFrequenciesFormatter(value, row) {
                if (typeof row !== "undefined" && typeof row.annotation !== "undefined"
                    && typeof row.annotation.populationFrequencies !== "undefined") {

                    let popFreqMap = new Map();
                    for (let popFreq of row.annotation.populationFrequencies) {
                        popFreqMap.set(popFreq.study + ":" + popFreq.population, Number(popFreq.altAlleleFreq).toFixed(4));
                    }

                    return this.variantGridFormatter.createPopulationFrequenciesTable(this._config.populationFrequencies,
                        popFreqMap, this.populationFrequencies.color);
                } else {
                    return "-";
                }
            }

            clinicalPhenotypeFormatter(value, row, index) {
                let phenotypeHtml = "<span><i class='fa fa-times' style='color: red'></i></span>";
                if (typeof row !== "undefined" && typeof row.annotation !== "undefined") {
                    if (UtilsNew.isNotUndefinedOrNull(row.annotation.variantTraitAssociation)) {
                        let traits = [];
                        let clinicalData = row.annotation.variantTraitAssociation[this.field];
                        if (UtilsNew.isNotEmptyArray(clinicalData)) {
                            for (let j = 0; j < clinicalData.length; j++) {
                                if (this.field === "clinvar" && traits.indexOf(clinicalData[j].traits[0]) === -1
                                    && clinicalData[j].traits[0] !== "not specified" && clinicalData[j].traits[0] !== "not provided") {
                                    traits.push(clinicalData[j].traits[0]);
                                } else if (this.field === "cosmic" && traits.indexOf(clinicalData[j].primaryHistology) === -1) {
                                    traits.push(clinicalData[j].primaryHistology);
                                }
                            }

                            if (traits.length > 0) {
                                let traitText = traits[0];
                                if (traits.length > 1) {
                                    traitText += ", ..."
                                }
                                phenotypeHtml = `<span data-toggle="tooltip" data-placement="bottom" title="${traitText}"><i class='fa fa-check' style='color: green'></i></span>`;
                            }
                        }
                    }
                }
                return phenotypeHtml;
            }

            interpretationFormatter(value, row, index) {
                let tiers = {
                    tier1: [], tier2: [], tier3: []
                };
                let modeOfInheritances = [];

                for (let re of row.reportedEvents) {
                    if (UtilsNew.isNotUndefinedOrNull(re.modeOfInheritance) && !modeOfInheritances.includes(re.modeOfInheritance)) {
                        modeOfInheritances.push(re.modeOfInheritance);
                    }

                    if (UtilsNew.isNotUndefinedOrNull(re.tier)) {
                        let obj = {tier: re.tier, acmg: re.classification.acmg.join(", ")};
                        switch (re.tier.toLowerCase()) {
                            case "tier 1":
                            case "tier1":
                                tiers.tier1.push(obj);
                                break;
                            case "tier 2":
                            case "tier2":
                                tiers.tier2.push(obj);
                                break;
                            case "tier 3":
                            case "tier3":
                                tiers.tier3.push(obj);
                                break;
                        }
                    }
                }

                let tierHtml = "<div>" + "-";
                if (tiers.tier1.length > 0) {
                    tierHtml = `<span style="color: red">${tiers.tier1[0].tier}</span> (${tiers.tier1[0].acmg})`;
                } else if (tiers.tier2.length > 0) {
                    tierHtml = `<span style="color: darkorange">${tiers.tier2[0].tier}</span> (${tiers.tier2[0].acmg})`;
                } else if (tiers.tier3.length > 0) {
                    tierHtml = `<span style="color: blue">${tiers.tier3[0].tier}</span> (${tiers.tier3[0].acmg})`;
                }
                tierHtml += "</div>";

                let moiHtml = `<div style='padding-top: 10px'>${modeOfInheritances.join(", ")}</div>`;

                return `${tierHtml}${moiHtml}`;
            }

            _createDefaultColumns() {
                if (this.variantGridFormatter === undefined) {
                    return;
                }

                this._columns = [
                    [
                        {
                            title: "Variant",
                            field: "id",
                            rowspan: 2,
                            colspan: 1,
                            // formatter: this.variantGridFormatter.variantFormatter.bind(this),
                            formatter: this.variantFormatter.bind(this),
                            halign: 'center',
                            sortable: true
                        },
                        {
                            title: "Genes",
                            field: "genes",
                            rowspan: 2,
                            colspan: 1,
                            formatter: this.variantGridFormatter.geneFormatter.bind(this),
                            halign: 'center',
                        },
                        {
                            title: "Type",
                            field: "type",
                            rowspan: 2,
                            colspan: 1,
                            formatter: this.variantGridFormatter.typeFormatter.bind(this),
                            halign: 'center'
                        },
                        {
                            title: "Gene Annotation",
                            field: "consequenceType",
                            rowspan: 2,
                            colspan: 1,
                            formatter: this.variantGridFormatter.consequenceTypeFormatter.bind(this),
                            halign: 'center'
                        },
                        {
                            title: "Variant Stats <span id='popFreqInfoIcon'><i class='fa fa-info-circle' style='color: #337ab7' aria-hidden='true'></i></span>",
                            field: "frequencies",
                            rowspan: 1,
                            colspan: 2,
                            align: 'center'
                        },
                        {
                            title: 'Phenotypes',
                            field: "phenotypes",
                            rowspan: 1,
                            colspan: 2,
                            align: 'center'
                        },
                        {
                            title: "Interpretation",
                            field: "interpretation",
                            rowspan: 1,
                            colspan: 2,
                            halign: 'center'
                        },
                    ],
                    [
                        {
                            title: 'Cohorts',
                            field: 'cohort',
                            colspan: 1,
                            rowspan: 1,
                            formatter: this.studyCohortsFormatter.bind(this),
                        },
                        {
                            title: 'Population Frequencies',
                            field: 'populationFrequencies',
                            colspan: 1,
                            rowspan: 1,
                            formatter: this.clinicalPopulationFrequenciesFormatter.bind(this),
                        },
                        // {
                        //     title: "Max Allele Freq",
                        //     field: "maxAlleleFreq",
                        //     rowspan: 1,
                        //     colspan: 1,
                        //     // halign: 'center'
                        // },
                        {
                            title: 'ClinVar',
                            field: 'clinvar',
                            colspan: 1,
                            rowspan: 1,
                            formatter: this.clinicalPhenotypeFormatter,
                            align: 'center'
                        },
                        {
                            title: 'Cosmic',
                            field: 'cosmic',
                            colspan: 1,
                            rowspan: 1,
                            formatter: this.clinicalPhenotypeFormatter,
                            align: 'center'
                        },
                        {
                            title: "Prediction",
                            field: "prediction",
                            rowspan: 1,
                            colspan: 1,
                            formatter: this.interpretationFormatter,
                            halign: 'center',
                            // formatter: this.predictionFormatter
                        },
                        // {
                        //     title: "Select",
                        //     field: "selectForInterpretation",
                        //     rowspan: 1,
                        //     colspan: 1,
                        //     align: 'center'
                        // }
                    ]
                ];

                // update columns dynamically
                this._updateTableColumns();

                return this._columns;
            }

            _updateTableColumns() {
                // Add a checkbox column
                if (this._config.showSelectCheckbox) {
                    this._columns[1].push({
                        // field: "stateCheckBox",
                        checkbox: true,
                        rowspan: 1,
                        colspan: 1
                    });
                }

                let sampleInfo = {};
                if (UtilsNew.isNotEmptyArray(this.individuals)) {
                    let probandId = (UtilsNew.isNotUndefinedOrNull(this.clinicalAnalysis.proband)) ? this.clinicalAnalysis.proband.id : "";
                    for (let individual of this.individuals) {
                        let affected = false;
                        for (let disorder of individual.disorders) {
                            if (disorder.id === this.clinicalAnalysis.disorder.id) {
                                affected = true;
                                break;
                            }
                        }
                        let role = "";
                        for (let ind of this.individuals) {
                            if (UtilsNew.isNotUndefinedOrNull(ind.father) && ind.father.id === individual.id) {
                                role = "father";
                            }
                            if (UtilsNew.isNotUndefinedOrNull(ind.mother) && ind.mother.id === individual.id) {
                                role = "mother";
                            }
                        }

                        sampleInfo[individual.samples[0].id] = {
                            proband: individual.id === probandId,
                            affected: affected,
                            role: role,
                            sex: individual.sex
                        };
                    }
                }

                if (typeof this._columns !== "undefined" && UtilsNew.isNotEmptyArray(this.samples)) {
                    this._columns[0].splice(4, 0, {
                        title: 'Sample Genotypes',
                        field: 'zygosity',
                        rowspan: 1,
                        colspan: this.samples.length,
                        align: 'center'
                    });

                    for (let i = 0; i < this.samples.length; i++) {
                        let color = "black";
                        if (sampleInfo[this.samples[i].id].proband) {
                            color = "darkred";
                            if (UtilsNew.isEmpty(sampleInfo[this.samples[i].id].role)) {
                                sampleInfo[this.samples[i].id].role = "proband";
                            }
                        }

                        let affected = "<span>UnAff.</span>";
                        if (sampleInfo[this.samples[i].id].affected) {
                            affected = "<span style='color: red'>Aff.</span>";
                        }

                        this._columns[1].splice(i, 0, {
                            title: `<span style="color: ${color}">${this.samples[i].id}</span>
                                    <br>
                                    <span style="font-style: italic">${sampleInfo[this.samples[i].id].role}, ${affected}</span>`,
                            // field: 'samples',
                            field: {
                                memberIdx: i,
                                memberName: this.samples[i].id,
                                quality: this._config.quality,
                                clinicalAnalysis: this.clinicalAnalysis
                            },
                            rowspan: 1,
                            colspan: 1,
                            formatter: this.zygosityFormatter,
                            align: 'center',
                            nucleotideGenotype: true,
                        });
                    }

                    // Add Proband File Metrics
                    // this._columns[0].splice(5, 0, {
                    //     title: "Pathogenicity",
                    //     field: "pathogenicity",
                    //     rowspan: 2,
                    //     colspan: 1,
                    //     formatter: this.pathogeniticyFormatter,
                    //     halign: 'center'
                    // });
                }
            }

            onDownload(e) {
                let urlQueryParams = this._getUrlQueryParams();
                let params = urlQueryParams.queryParams;
                params.limit = 1000; // Default limit is 1000 for now

                this.downloadRefreshIcon.css('display', 'inline-block');
                this.downloadIcon.css('display', 'none');

                let _this = this;
                this.opencgaSession.opencgaClient.variants().query(params)
                    .then(function (response) {
                        let result = response.response[0].result;
                        let dataString = [];
                        let mimeType = "";
                        let extension = "";

                        // Check if user clicked in Tab or JSON format
                        if (e.detail.option.toLowerCase() === "tab") {
                            dataString = VariantUtils.jsonToTabConvert(result, _this.populationFrequencies.studies, _this.samples, _this._config.nucleotideGenotype);
                            mimeType = "text/plain";
                            extension = ".txt";
                        } else {
                            for (let res of result) {
                                dataString.push(JSON.stringify(res));
                            }
                            mimeType = "application/json";
                            extension = ".json";
                        }

                        // Build file and anchor link
                        let data = new Blob([dataString.join('\n')], {type: mimeType});
                        let file = window.URL.createObjectURL(data);
                        let a = document.createElement("a");
                        a.href = file;
                        a.download = _this.opencgaSession.study.alias + extension;
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(function () {
                            document.body.removeChild(a);
                        }, 0);
                    })
                    .then(function () {
                        _this.downloadRefreshIcon.css('display', 'none');
                        _this.downloadIcon.css('display', 'inline-block');
                    });
            }

            onShare() {
                let _this = this;
                $("[data-toggle=popover]").popover({
                    content: function() {
                        let getUrlQueryParams = _this._getUrlQueryParams();
                        let query = ["limit=1000"];
                        for (let key in getUrlQueryParams.queryParams) {
                            // Check sid has a proper value. For public projects sid is undefined. In that case, sid must be removed from the url
                            if (key === "sid" && getUrlQueryParams.queryParams[key] === undefined) {
                                delete getUrlQueryParams.queryParams["sid"];
                            } else {
                                query.push(key + "=" + getUrlQueryParams.queryParams[key]);
                            }
                        }
                        return getUrlQueryParams.host + "?" + query.join("&");
                    }
                }).on("show.bs.popover", function () {
                    $(this).data("bs.popover").tip().css("max-width", "none");
                });
            }

            getDefaultConfig() {
                return {
                    pagination: true,
                    pageSize: 10,
                    pageList: [10, 25, 50],
                    showExport: false,
                    detailView: true,
                    detailFormatter: this.detailFormatter,

                    showSelectCheckbox: false,
                    multiSelection: false,
                    nucleotideGenotype: true,
                    alleleStringLengthMax: 15,

                    header: {
                        horizontalAlign: 'center',
                        verticalAlign: 'bottom'
                    },

                    quality: {
                        qual: 30,
                        dp: 20
                    },
                    populationFrequencies: ["1kG_phase3:ALL", "GNOMAD_GENOMES:ALL", "GNOMAD_EXOMES:ALL", "UK10K:ALL", "GONL:ALL", "ESP6500:ALL", "EXAC:ALL"]
                }
            }
        }

        customElements.define(OpencgaInterpretedVariantGrid.is, OpencgaInterpretedVariantGrid);
    </script>
</dom-module>
