<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<dom-module id="opencga-variant-file-metrics">
    <template>
        <style include="jso-styles"></style>

        <div id="{{prefix}}FileMetrics">
            <div class="col-md-10 col-md-offset-1" style="padding-top: 20px;overflow: auto;">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>VCF Attributes</th>
                        <template is="dom-repeat" items="{{variant.studies.0.files}}" as="member">
                            <th>{{member.fileId}}</th>
                        </template>
                    </tr>
                    </thead>
                    <tbody id="{{prefix}}TableTBody">
                    <template is="dom-repeat" items="{{_attributes}}" as="attribute">
                        <tr id="{{attribute.name}}" class$="file-metrics-table-{{attribute.name}}">
                            <td><span style="font-weight: bold">{{attribute.name}}</span></td>
                            <template is="dom-repeat" items="{{attribute.values}}" as="attr">
                                <td>{{attr}}</td>
                            </template>
                        </tr>
                    </template>
                    </tbody>
                </table>
            </div>
        </div>
    </template>

    <script>
        class OpencgaVariantFileMetrics extends Polymer.Element {

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object
                    },
                    variant: {
                        type: Object,
                    },
                    clinicalAnalysis: {
                        type: Object,
                    },
                    // active: {
                    //     type: Boolean,
                    //     value: false,
                    // },
                    config: {
                        type: Object,
                    }
                }
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            static get is() {
                return 'opencga-variant-file-metrics'
            };

            constructor() {
                super();

                // Set status and init private properties
                this._init();
            }

            // This is executed before the actual Polymer properties exist
            _init() {
                // All id fields in the template must start with prefix, this allows components to be instantiated more than once
                this.prefix = "ovfm" + Utils.randomString(6);
            }

            static get observers() {
                return [
                    "propertyObserver(opencgaSession, variant, config)"
                ];
            }

            propertyObserver(opencgaSession, variant, config) {
                this.renderTable();
            }

            renderTable() {
                if (UtilsNew.isUndefinedOrNull(this.variant) || UtilsNew.isEmptyArray(this.variant.studies)) {
                    return [];
                }

                // We take the first study by default. Two possible improvements are:
                // 1. we could pass a new studyId parameter to choose the study
                // 2. render all of the studies in different tables or the same table with two-level columns
                let files = this.variant.studies[0].files;
                let attributesSet = new Set();
                // We find all the existing attributes
                for (let file of files) {
                    for(let attr of Object.keys(file.attributes)) {
                        if (attr !== "QUAL" && attr !== "FILTER") {
                            attributesSet.add(attr);
                        }
                    }
                }
                let attributesArray = Array.from(attributesSet.values()).sort();
                attributesArray.unshift("QUAL", "FILTER");

                // We store the values as: result = [{name: "AC", values: [1, 2, 3, 4]}]
                let result = [];
                for (let attr of attributesArray) {
                    let tmp = {name: attr, values: []};
                    for (let file of files) {
                        tmp.values.push(file.attributes[attr]);
                    }
                    result.push(tmp);
                }
                this._attributes = result;
                // return result;
            }

            getDefaultConfig() {
                return {
                    property: "example property"
                };
            }
        }

        customElements.define(OpencgaVariantFileMetrics.is, OpencgaVariantFileMetrics);
    </script>
</dom-module>