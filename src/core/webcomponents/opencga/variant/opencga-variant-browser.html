<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="opencga-variant-filter.html">
<link rel="import" href="../opencga-active-filters.html">
<link rel="import" href="opencga-variant-grid.html">
<link rel="import" href="opencga-variant-cohort-stats.html">
<link rel="import" href="opencga-variant-samples.html">
<link rel="import" href="variant-beacon-network.html">
<link rel="import" href="variant-genome-browser.html">
<link rel="import" href="../../reactome/reactome-variant-network.html">
<link rel="import" href="../opencga-genome-browser.html">
<link rel="import" href="../../cellbase/variation/cellbase-variantannotation-view.html">
<link rel="import" href="opencga-variant-detail-template.html">

<dom-module id="opencga-variant-browser">
    <template>
        <style include="jso-styles">
            .browser-center {
                margin: auto;
                text-align: justify;
                width: 95%;
            }

            .browser-variant-tab-title {
                font-size: 115%;
                font-weight: bold;
            }

            th {
                text-align: center
            }

            .icon-padding {
                padding-left: 4px;
                padding-right: 5px;
            }
        </style>

        <template is="dom-if" if="{{checkProjects}}">

            <div class="panel" style="margin-bottom: 15px">
                <h3 style="margin: 10px 10px 10px 15px">
                <span on-click="onCollapse" style="cursor: pointer;margin: 0px 30px 0px 0px">
                    <i class="fa fa-bars" aria-hidden="true"></i>
                </span>
                    <i class="fa fa-search" aria-hidden="true"></i>&nbsp;{{config.title}}
                </h3>
            </div>

            <div class="row" style="padding: 0px 10px">
                <div id="{{prefix}}FilterMenu" class="col-md-2">
                    <opencga-variant-filter opencga-session="{{opencgaSession}}"
                                            query="{{query}}"
                                            cohorts="[[cohorts]]"
                                            cellbase-client="{{cellbaseClient}}"
                                            population-frequencies="{{populationFrequencies}}"
                                            consequence-types="{{consequenceTypes}}"
                                            on-querychange="onQueryFilterChange" on-querysearch="onQueryFilterSearch" on-samplechange="onSampleChange"
                                            config="{{_config.filter}}">
                    </opencga-variant-filter>
                </div>

                <div id="{{prefix}}MainWindow" class="col-md-10">
                    <opencga-active-filters opencga-client="{{opencgaSession.opencgaClient}}" default-study="{{opencgaSession.study.alias}}"
                                            query="{{preparedQuery}}" refresh="{{executedQuery}}"
                                            filters="{{_config.filter.examples}}"
                                            on-filterchange="onActiveFilterChange" on-clear="onClear"
                                            filter-bioformat="VARIANT" alias="{{_config.activeFilterAlias}}"
                                            config="{{_config.activeFilters}}">
                    </opencga-active-filters>

                    <div class="col-md-12" style="padding: 5px 0px 5px 0px">
                        <div class="btn-toolbar" role="toolbar" aria-label="..." style="padding: 10px 0px;margin-left: 0px">
                            <div id="{{prefix}}LeftToolbar" style="padding-bottom: 0px">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-success variant-browser-view-buttons active" data-view="TableResult" on-click="_changeView">
                                        <i class="fa fa-table icon-padding" aria-hidden="true" data-view="TableResult" on-click="_changeView"></i> Table Result
                                    </button>
                                    <template is="dom-if" if="{{config.showSummary}}">
                                        <button type="button" class="btn btn-success variant-browser-view-buttons" data-view="Summary" on-click="_changeView">
                                            <i class="fa fa-line-chart icon-padding" aria-hidden="true" data-view="Summary" on-click="_changeView"></i> Summary (Beta)
                                        </button>
                                    </template>
                                    <template is="dom-if" if="{{config.showGenomeBrowser}}">
                                        <button id="{{prefix}}GenomeBrowserButton" type="button" class="btn btn-success variant-browser-view-buttons" data-view="GenomeBrowser" on-click="_changeView">
                                            <i class="fa fa-list-alt icon-padding" aria-hidden="true" data-view="GenomeBrowser" on-click="_changeView"></i> Genome Browser (Beta)
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <!-- First TAB -->
                        <div id="{{prefix}}TableResult" class="variant-browser-content">
                            <!-- Variant Browser Grid -->
                            <opencga-variant-grid opencga-session="{{opencgaSession}}"
                                                  query="{{executedQuery}}" cohorts="[[cohorts]]"
                                                  cellbase-client="{{cellbaseClient}}"
                                                  population-frequencies="{{populationFrequencies}}" active="{{active}}"
                                                  protein-substitution-scores="{{proteinSubstitutionScores}}"
                                                  consequence-types="{{consequenceTypes}}"
                                                  on-selected="selectedGene" on-selectvariant="onSelectVariant"
                                                  on-setgenomebrowserposition="onGenomeBrowserPositionChange"
                                                  style="font-size: 12px" config="{{config}}">
                            </opencga-variant-grid>


                            <!-- Bottom tabs with specific variant information -->
                            <div style="padding-top: 20px" hidden$="{{!checkVariant(variant)}}">
                                <h3>Variant: {{variant}}</h3>
                                <div style="padding-top: 20px">
                                    <!-- Dynamically create the Detail Tabs from Browser config -->
                                    <ul id="{{prefix}}ViewTabs" class="nav nav-tabs" role="tablist">
                                        <template is="dom-repeat" items="{{config.detail}}">
                                            <template is="dom-if" if="{{item.active}}">
                                                <li role="presentation" class="active">
                                                    <a href="#{{prefix}}{{item.id}}" role="tab" data-toggle="tab" data-id$="{{item.id}}"
                                                       class="browser-variant-tab-title" on-click="_changeBottomTab">{{item.title}}</a>
                                                </li>
                                            </template>
                                            <template is="dom-if" if="{{!item.active}}">
                                                <li role="presentation" class="">
                                                    <a href="#{{prefix}}{{item.id}}" role="tab" data-toggle="tab" data-id$="{{item.id}}"
                                                       class="browser-variant-tab-title" on-click="_changeBottomTab">{{item.title}}</a>
                                                </li>
                                            </template>
                                        </template>
                                    </ul>

                                    <div class="tab-content" style="height: 680px">
                                        <!-- Annotation Tab -->
                                        <div id="{{prefix}}annotation" role="tabpanel" class="tab-pane active">
                                            <div style="width: 90%;padding-top: 8px">
                                                <cellbase-variantannotation-view data="{{variant}}" assembly={{opencgaSession.project.organism.assembly}} prefix="{{prefix}}"
                                                                                 cellbase-client="{{cellbaseClient}}" mode="vertical"
                                                                                 hash-fragment-credentials="{{hashFragmentCredentials}}"
                                                                                 consequence-types="{{consequenceTypes}}"
                                                                                 protein-substitution-scores="{{proteinSubstitutionScores}}"
                                                                                 style="font-size: 12px">
                                                </cellbase-variantannotation-view>
                                            </div>
                                        </div>

                                        <!-- Cohort Stats Tab -->
                                        <div id="{{prefix}}cohortStats" role="tabpanel" class="tab-pane">
                                            <div style="width: 75%;padding-top: 8px">
                                                <opencga-variant-cohort-stats opencga-session="{{opencgaSession}}" variant="{{variant}}" active="{{detailActiveTabs.cohortStats}}"></opencga-variant-cohort-stats>
                                            </div>
                                        </div>

                                        <!-- Samples Tab -->
                                        <div id="{{prefix}}samples" role="tabpanel" class="tab-pane">
                                            <div style="width: 75%;padding-top: 8px">
                                                <opencga-variant-samples opencga-session="{{opencgaSession}}" variant="{{variant}}" active="{{detailActiveTabs.samples}}"></opencga-variant-samples>
                                            </div>
                                        </div>

                                        <!-- Beacon Network Tab-->
                                        <div id="{{prefix}}beacon" role="tabpanel" class="tab-pane">
                                            <div style="width: 75%;padding-top: 8px">
                                                <variant-beacon-network variant="{{variant}}" clear="{{variant}}" config="{{beaconConfig}}"></variant-beacon-network>
                                            </div>
                                        </div>

                                        <!-- Reactome network tab -->
                                        <div id="{{prefix}}network" role="tabpanel" class="tab-pane">
                                            <div style="width: 75%;padding-top: 8px">
                                                <reactome-variant-network opencga-session="{{opencgaSession}}" reactome-client="{{reactomeClient}}" genes="{{genes}}" active="{{detailActiveTabs.network}}"></reactome-variant-network>
                                            </div>
                                        </div>

                                        <!-- Example Template Tab-->
                                        <div id="{{prefix}}template" role="tabpanel" class="tab-pane">
                                            <div style="width: 75%;padding-top: 8px">
                                                <opencga-variant-detail-template opencga-session="{{opencgaSession}}" variant="{{variant}}" active="{{detailActiveTabs.template}}"></opencga-variant-detail-template>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Second TAB -->
                        <div id="{{prefix}}Summary" class="variant-browser-content" style="display: none">
                            <br>
                            <div class="col-md-6">
                                <h4>Consequence Type</h4>
                                <div id="{{prefix}}soAcc"></div>
                            </div>
                            <div class="col-md-6">
                                <h4>Gene</h4>
                                <div id="{{prefix}}genes"></div>
                            </div>
                            <div class="col-md-6">
                                <h4>Variant Type</h4>
                                <div id="{{prefix}}type"></div>
                            </div>
                            <div class="col-md-6">
                                <h4>Studies</h4>
                                <div id="{{prefix}}studies"></div>
                            </div>
                        </div>

                        <!-- Third TAB -->
                        <div id="{{prefix}}GenomeBrowser" class="variant-browser-content" style="display: none">
                            <br>
                            <br>
                            <opencga-genome-browser opencga-session="{{opencgaSession}}" opencga-client="{{opencgaSession.opencgaClient}}"
                                                    cellbase-client="{{cellbaseClient}}"
                                                    query={{preparedQuery}} search={{executedQuery}} species={{config.species}}
                                                    region="{{region}}" active="{{_genomeBrowserActive}}" full-screen="{{fullScreen}}"
                                                    config="{{_config.genomeBrowser}}">
                            </opencga-genome-browser>
                        </div>
                    </div>

                    <div class="modal fade" id="{{prefix}}LoadingModal" data-backdrop="static" data-keyboard="false" tabindex="-1"
                         role="dialog" aria-hidden="true" style="padding-top:15%; overflow-y:visible;">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3>Loading...</h3>
                                </div>
                                <div class="modal-body">
                                    <div class="progress progress-striped active">
                                        <div class="progress-bar progress-bar-success" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <template is="dom-if" if="{{!checkProjects}}">
            <span style="text-align: center"><h3>No public projects available to browse. Please login to continue</h3></span>
        </template>
    </template>

    <script>
        class OpencgaVariantBrowser extends Polymer.Element {

            constructor() {
                super();

                // Set status and init private properties
                this._init();
            }

            static get is() {
                return 'opencga-variant-browser';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object,
                    },
                    reactomeClient: {
                        type: Object
                    },
                    query: {
                        type: Object,
                        observer: "queryObserver"
                    },
                    samples: {
                        type: Array
                    },
                    cellbaseClient: {
                        type: Object
                    },
                    populationFrequencies: {
                        type: Object
                    },
                    consequenceTypes: {
                        type: Object
                    },
                    proteinSubstitutionScores: {
                        type: Object
                    },
                    config: {
                        type: Object
                    }
                }
            }

            static get observers() {
                /*
                 * We do not need to Observer 'query' property, when passed it will be shared (bound) with the other components.
                 * 'search; is observed to ensure 'query' is in sync.
                 */
                return [
                    "propertyObserver(opencgaSession, config)"
                ];
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            _init() {
                this.prefix = "ovb-" + Utils.randomString(6);

                this.checkProjects = false;
                this._collapsed = false;
                this.genotypeColor = {
                    "0/0": "#6698FF",
                    "0/1": "#FFA500",
                    "1/1": "#FF0000",
                    "./.": "#000000",
                    "0|0": "#6698FF",
                    "0|1": "#FFA500",
                    "1|0": "#FFA500",
                    "1|1": "#FF0000",
                    ".|.": "#000000",
                };
                this.variant = "No variant selected";

                this._config = this.getDefaultConfig();
            }

            propertyObserver(opencgaSession, config) {
                // With each property change we must updated config and create the columns again. No extra checks are needed.
                this._config = Object.assign(this.getDefaultConfig(), config);

                // Check if Beacon hosts are configured
                for (let detail of this._config.detail) {
                    if (detail.id === "beacon" && UtilsNew.isNotEmptyArray(detail.hosts)) {
                        this.beaconConfig = {
                            hosts: detail.hosts
                        };
                    }
                }

                // Update cohorts from config, this updates the Cohort filter MAF
                if (UtilsNew.isNotUndefinedOrNull(opencgaSession) && UtilsNew.isNotUndefinedOrNull(opencgaSession.project)) {
                    // this.preparedQuery = {};
                    // this.executedQuery = {};
                    // this.query = {};
                    for (let section of this._config.filter.menu.sections) {
                        for (let subsection of section.subsections) {
                            if (subsection.id === "cohort") {
                                let projectFields = this.opencgaSession.project.alias.split("@");
                                let projectId = (projectFields.length > 1) ? projectFields[1] : projectFields[0];
                                this.cohorts = subsection.cohorts[projectId];
                            }
                        }
                    }
                    this.checkProjects = true;
                } else {
                    this.checkProjects = false;
                }

                // Query passed is executed and set to variant-filter, active-filters and variant-grid components
                // if (UtilsNew.isNotUndefinedOrNull(query)) {
                //     debugger
                //     this.preparedQuery = query;
                //     this.executedQuery = query;
                // }
            }

            queryObserver() {
                // Query passed is executed and set to variant-filter, active-filters and variant-grid components
                let _query = {};
                if (UtilsNew.isEmpty(this.query) && UtilsNew.isNotUndefinedOrNull(this.opencgaSession)) {
                    _query = {study: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias}
                }

                if (UtilsNew.isNotUndefinedOrNull(this.query)) {
                    this.preparedQuery = Object.assign(_query, this.query);
                    this.executedQuery = Object.assign(_query, this.query);
                }
            }

            onCollapse() {
                if (this._collapsed) {
                    $("#" + this.prefix + "FilterMenu").show(400);
                    $("#" + this.prefix + "MainWindow").removeClass("browser-center").addClass("col-md-10");
                } else {
                    $("#" + this.prefix + "FilterMenu").hide(400);
                    $("#" + this.prefix + "MainWindow").removeClass("col-md-10").addClass("browser-center");
                }
                this._collapsed = !this._collapsed;
            }

            /*
             * Variant Filter component listeners
             */
            onQueryFilterChange(e) {
                this.preparedQuery = e.detail.query;
            }

            onQueryFilterSearch(e) {
                this.preparedQuery = e.detail.query;
                this.executedQuery = e.detail.query;
            }

            /*
             * Active Filters component listeners
             */
            onActiveFilterChange(e) {
                this.query = Object.assign({study: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias}, e.detail);
            }

            onClear() {
                this.query = {
                    study: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias
                };
            }


            onSampleChange(e) {
                this.set('samples', e.detail.samples);
                this.dispatchEvent(new CustomEvent("samplechange", {detail: {samples: this.samples}, bubbles: true, composed: true}));
            }

            _changeBottomTab(e) {
                let _activeTabs = {};
                for (let detail of this.config.detail) {
                    _activeTabs[detail.id] = (detail.id === e.currentTarget.dataset.id);
                }
                this.set("detailActiveTabs", _activeTabs);
            }

            onGenomeBrowserPositionChange(e) {
                $('.variant-browser-content').hide(); // hides all content divs

                // Show genome browser div
                PolymerUtils.getElementById(this.prefix + "GenomeBrowser").style.display = "block";

                // Show the active button
                $('.variant-browser-view-buttons').removeClass("active");
                PolymerUtils.addClass(this.prefix + "GenomeBrowserButton", "active");

                this._genomeBrowserActive = true;

                this.region = e.detail.genomeBrowserPosition;
            }

            checkVariant(variant) {
                return variant.split(':').length > 2;
            }

            onSelectVariant(e) {
                this.variant = e.detail.id;

                let genes = [];
                for (let i = 0; i < e.detail.variant.annotation.consequenceTypes.length; i++) {
                    let gene = e.detail.variant.annotation.consequenceTypes[i].geneName;
                    if (UtilsNew.isNotEmpty(gene) && genes.indexOf(gene) === -1) {
                        genes.push(gene);
                    }
                }
                this.genes = genes;
            }

            selectedGene(e) {
                this.dispatchEvent(new CustomEvent('propagate', {gene: e.detail.gene}));
            }

            fetchFacets() {
                let queryParams = {
                    sid: this.opencgaSession.opencgaClient._config.sessionId,
                    study: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias,
                    facet: "type;genes;soAcc;studies",
                    timeout: 60000
                };
                Object.assign(queryParams, this.query);

                if (typeof queryParams.sid === "undefined" || queryParams.sid === "") {
                    delete queryParams["sid"];
                }

                let _this = this;

                // Shows loading modal
                $("#" + this.prefix + "LoadingModal").modal("show");

                setTimeout(_ => {
                    this.opencgaSession.opencgaClient.variants().facet(queryParams, {})
                        .then(function (queryResponse) {
                            _this.facetResults = queryResponse.response[0].result[0].result.fields;
                            for (let result of _this.facetResults) {
                                let categories = [];
                                let data = [];

                                for (let countObj of result.counts) {
                                    categories.push(countObj.value);
                                    data.push(countObj.count);
                                }

                                $("#" + _this.prefix + result.name).highcharts({
                                    credits: {enabled: false},
                                    chart: {
                                        type: "column"
                                    },
                                    title: {
                                        text: result.name
                                    },
                                    xAxis: {
                                        categories: categories
                                    },
                                    yAxis: {
                                        min: 0,
                                        title: {
                                            text: 'Total number of Variants'
                                        }
                                    },
                                    tooltip: {
                                        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                                        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                                            '<td style="padding:0"><b>{point.y:.1f} </b></td></tr>',
                                        footerFormat: '</table>',
                                        shared: true,
                                        useHTML: true
                                    },
                                    plotOptions: {
                                        column: {
                                            pointPadding: 0.2,
                                            borderWidth: 0
                                        }
                                    },
                                    series: [{
                                        name: result.name,
                                        data: data
                                    }]
                                });
                            }

                            // Remove loading modal
                            $("#" + _this.prefix + "LoadingModal").modal("hide");
                        })
                        .catch(function (e) {
                            // Remove loading modal
                            $("#" + _this.prefix + "LoadingModal").modal("hide");
                        });
                }, 250);
            }

            // This observer is needed when pie charts are rendered instead of table. This is where the data needed for high charts is prepared
            variantStudiesChanged() {
                this.$.variantStudies.render();
                if (this.variantStudies.length > 0) {
                    for (let i = 0; i < this.variantStudies.length; i++) {
                        let statsArray = this.variantStudies[i].stats;
                        for (let j = 0; j < statsArray.length; j++) {
                            let genotypeCount = statsArray[j].value.genotypesCount;
                            let data = [];
                            if (Object.keys(genotypeCount).length > 0) {
                                for (let k in genotypeCount) {
                                    data.push({
                                        name: k,
                                        y: genotypeCount[k],
                                        color: this.genotypeColor[k]
                                    });
                                }
                                let params = {title: statsArray[j].name, data: data};
                                this._updatePieChart("#" + statsArray[j].study + statsArray[j].name, params);
                            }
                        }
                    }
                }
            }

            getStudy(study) {
                if (study !== undefined) {
                    let fields = study.split(':');
                    return fields[fields.length - 1];
                }
                return "";
            }

            checkForGenotypes(stat) {
                let genotypesCount = stat.value.genotypesCount;
                return Object.keys(genotypesCount).length > 0;
            }

            checkForSampleData(samplesData) {
                return samplesData.length > 0;
            }

            _changeView(e) {
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                $('.variant-browser-content').hide(); // hides all content divs
                if (typeof e.target !== "undefined" && typeof e.target.dataset.view !== "undefined") {
                    // $("#" + this.prefix + e.target.dataset.view).show(); // get the href and use it find which div to show
                    PolymerUtils.show(this.prefix + e.target.dataset.view);
                }

                // Show the active button
                $('.variant-browser-view-buttons').removeClass("active");
                $(e.target).addClass("active");

                if (e.target.dataset.view === "Summary") {
                    this.fetchFacets();
                }

                if (e.target.dataset.view === "GenomeBrowser") {
//                    window.location.hash = "genomebrowser";
                    this._genomeBrowserActive = true;
                } else {
                    this._genomeBrowserActive = false;
                }
            }

            // This is the old Pie Chart implementation, not used right now
            _updatePieChart(_id, params) {
                // params = { title, data}
                $(_id).highcharts({
                    credits: {enabled: false},
                    chart: {
                        plotBackgroundColor: null,
                        plotBorderWidth: null,
                        plotShadow: false,
                        type: 'pie',
                        width: 220
                    },
                    title: {
                        text: params.title
                    },
                    tooltip: {
                        pointFormat: '{series.name}: <b>{point.percentage:.2f}%</b>'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            minSize: 75,
                            dataLabels: {
                                padding: 4,
                                connectorPadding: 4,
                                enabled: true,
                                format: '{point.name}: {point.percentage:.2f}%',
                                style: {
                                    color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                                }
                            }
                        }
                    },
                    series: [{
                        name: 'Genotype Count',
                        data: params.data
                    }]
                });
            }

            getDefaultConfig() {
                return {
                    activeFilters: {
                        alias: {
                            // Example:
                            // "region": "Region",
                            // "gene": "Gene",
                            // "genotype": "Sample Genotypes",
                        },
                        complexFields: ["genotype"],
                        hiddenFields: ["study"]
                    },
                    genomeBrowser: {
                        showTitle: false
                    }
                }
            }
        }

        customElements.define(OpencgaVariantBrowser.is, OpencgaVariantBrowser);
    </script>
</dom-module>
