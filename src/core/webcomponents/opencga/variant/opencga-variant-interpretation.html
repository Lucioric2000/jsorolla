<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="opencga-variant-filter.html">
<link rel="import" href="../opencga-active-filters.html">
<link rel="import" href="opencga-variant-interpretation-editor.html">
<link rel="import" href="opencga-variant-grid.html">
<link rel="import" href="opencga-interpreted-variant-grid.html">
<link rel="import" href="opencga-interpreted-variant-detail.html">
<link rel="import" href="../opencga-genome-browser.html">
<link rel="import" href="../clinical/clinical-analysis-view.html">
<link rel="import" href="../clinical/clinical-interpretation-view.html">

<dom-module id="opencga-variant-interpretation">
    <template>
        <style include="jso-styles">
            .prioritization-center {
                margin: auto;
                text-align: justify;
                width: 95%;
            }

            .browser-variant-tab-title {
                font-size: 115%;
                font-weight: bold;
            }

            .prioritization-variant-tab-title {
                font-size: 115%;
                font-weight: bold;
            }

            .icon-padding {
                padding-left: 4px;
                padding-right: 8px;
            }

            .form-section-title {
                padding: 5px 0px;
                width: 90%;
                border-bottom-width: 1px;
                border-bottom-style: solid;
                border-bottom-color: #ddd
            }

            .jso-label-title {
                width: 15em !important;
            }
        </style>

        <template is="dom-if" if="{{checkProjects}}">
            <div class="panel" style="margin-bottom: 15px">
                <h3 style="margin: 10px 10px 10px 15px">
                    <template is="dom-if" if="{{interactive}}">
                        <span on-click="onCollapse" style="cursor: pointer;margin: 0px 30px 0px 0px">
                            <i class="fa fa-bars" aria-hidden="true"></i>
                        </span>
                    </template>
                    <i class="fa fa-filter" aria-hidden="true"></i>&nbsp;{{config.title}}
                </h3>
            </div>

            <!--<div class="row">-->
            <div class="row" style="padding: 0px 10px">
                <div id="{{prefix}}FilterMenu" class$="{{filterClass}}">
                    <opencga-variant-filter opencga-session="{{opencgaSession}}"
                                            query="{{query}}"
                                            clinical-analysis="{{clinicalAnalysis}}"
                                            cellbase-client="{{cellbaseClient}}"
                                            population-frequencies="{{populationFrequencies}}"
                                            consequence-types="{{consequenceTypes}}"
                                            on-querychange="onQueryFilterChange" on-querysearch="onQueryFilterSearch" on-samplechange="onSampleChange"
                                            on-inheritancemode="_onInheritanceMode"
                                            config="{{_config.filter}}">
                    </opencga-variant-filter>
                </div>

                <div id="{{prefix}}MainWindow" class$="{{gridClass}}">
                    <opencga-active-filters opencga-client="{{opencgaSession.opencgaClient}}" default-study="{{opencgaSession.study.alias}}"
                                            query="{{preparedQuery}}" refresh="{{executedQuery}}"
                                            filters="{{_config.filter.examples}}"
                                            on-filterchange="onActiveFilterChange" on-clear="onClear"
                                            filter-bioformat="VARIANT" alias="{{_config.activeFilterAlias}}"
                                            genotype-samples="{{genotypeSamples}}" mode-inheritance="[[modeInheritance]]"
                                            config="{{_config.activeFilters}}">
                    </opencga-active-filters>


                    <div class="col-md-12" style="padding: 15px 0px">
                        <div class="btn-toolbar" role="toolbar" aria-label="..." >
                            <div class="btn-group" role="group" aria-label="..." >
                                <button type="button" class="btn btn-success variant-interpretation-view-buttons active" data-view="TableResult" on-click="_changeView">
                                    <i class="fa fa-table icon-padding" aria-hidden="true" data-view="TableResult" on-click="_changeView"></i>Table Result
                                </button>
                                <button type="button" class="btn btn-success variant-interpretation-view-buttons" data-view="ClinicalAnalysis" on-click="_changeView">
                                    <i class="fa fa-user-md icon-padding" aria-hidden="true" data-view="ClinicalAnalysis" on-click="_changeView"></i>Case Summary
                                </button>
                                <button type="button" class="btn btn-success variant-interpretation-view-buttons" data-view="LowCoverage" on-click="_changeView">
                                    <i class="fa fa-list-alt icon-padding" aria-hidden="true" data-view="LowCoverage" on-click="_changeView"></i>Low Coverage Regions
                                </button>
                                <button id="{{prefix}}GenomeBrowserButton" type="button" class="btn btn-success variant-interpretation-view-buttons" data-view="GenomeBrowser" on-click="_changeView">
                                    <i class="fa fa-list-alt icon-padding" aria-hidden="true" data-view="GenomeBrowser" on-click="_changeView"></i>Genome Browser (Beta)
                                </button>
                            </div>

                            <template is="dom-if" if="{{hasClinicalAnalysis}}">
                                <div class="btn-group" role="group" aria-label="..." style="float: right">
                                    <button id="{{prefix}}InterpretationEditorButton" type="button" class="btn btn-primary variant-interpretation-view-buttons"
                                            data-view="InterpretationEditor" on-click="_changeView">
                                        <i class="fa fa-floppy-o icon-padding" aria-hidden="true" data-view="InterpretationEditor" on-click="_changeView"></i>Review and Save Interpretation ({{checkedVariants.length}})
                                    </button>
                                </div>
                            </template>
                            <template is="dom-if" if="{{!hasClinicalAnalysis}}">
                                <div class="btn-group" role="group" aria-label="..." style="float: right">
                                    <button id="{{prefix}}ClinicalAnalysisButton" class="btn btn-primary variant-interpretation-view-buttons" data-view="clinicalAnalysisEditor" on-click="_changeView" >
                                        <i class="fa fa-edit icon-padding" aria-hidden="true" data-view="clinicalAnalysisEditor" on-click="_changeView"></i>Clinical Analysis Definition
                                    </button>
                                    <button id="{{prefix}}InterpretationEditorButton" type="button" class="btn btn-primary variant-interpretation-view-buttons"
                                            data-view="InterpretationEditor" on-click="_changeView">
                                        <i class="fa fa-floppy-o icon-padding" aria-hidden="true" data-view="InterpretationEditor" on-click="_changeView"></i>Review and Save Interpretation ({{checkedVariants.length}})
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div>
                        <!-- TABLE RESULT -->
                        <div id="{{prefix}}TableResult" class="variant-interpretation-content">
                            <template is="dom-if" if="{{interactive}}">
                                <!-- Variant Browser Grid -->
                                <opencga-interpreted-variant-grid opencga-session="{{opencgaSession}}" clinical-analysis="{{clinicalAnalysis}}"
                                                                  query="{{executedQuery}}"
                                                                  consequence-types="{{consequenceTypes}}"
                                                                  population-frequencies="{{populationFrequencies}}"
                                                                  protein-substitution-scores="{{proteinSubstitutionScores}}"
                                                                  on-selected="selectedGene"
                                                                  on-selectvariant="onSelectVariant"
                                                                  on-checkvariant="onCheckVariant"
                                                                  on-setgenomebrowserposition="onGenomeBrowserPositionChange"
                                                                  config="{{config.grid}}">
                                </opencga-interpreted-variant-grid>
                            </template>

                            <!-- Bottom tabs with detailed variant information -->
                            <opencga-interpreted-variant-detail opencga-session={{opencgaSession}}
                                                                cellbase-client={{cellbaseClient}}
                                                                variant={{variant}}
                                                                clinical-analysis={{clinicalAnalysis}}
                                                                consequence-types={{consequenceTypes}}
                                                                protein-substitution-scores="{{proteinSubstitutionScores}}"
                                                                config={{config.detail}}>
                            </opencga-interpreted-variant-detail>
                        </div>

                        <!-- CLINICAL ANALYSIS VIEW -->
                        <div id="{{prefix}}ClinicalAnalysis" class="variant-interpretation-content" style="display: none">
                            <clinical-analysis-view clinical-analysis={{clinicalAnalysis}} opencga-session="{{opencgaSession}}" opencga-client="{{opencgaSession.opencgaClient}}" config="{{config}}"
                                                    class="col-md-10 col-md-offset-1" style="font-size: 12px">
                            </clinical-analysis-view>
                        </div>

                        <!-- PANEL LOW COVERAGE VIEW -->
                        <div id="{{prefix}}LowCoverage" class="variant-interpretation-content" style="display: none">
                            <span>Low Coverage WIP</span>
                        </div>

                        <!-- GENOME BROWSER VIEW -->
                        <div id="{{prefix}}GenomeBrowser" class="variant-interpretation-content" style="display: none">
                            <opencga-genome-browser opencga-session="{{opencgaSession}}" samples="{{samples}}" opencga-client="{{opencgaSession.opencgaClient}}"
                                                    cellbase-client="{{cellbaseClient}}" query={{query}} search={{search}} region="{{search.region}}"
                                                    active="{{_genomeBrowserActive}}" full-screen="{{fullScreen}}" config="{{_config.genomeBrowser}}">
                            </opencga-genome-browser>
                        </div>


                        <!-- CREATE CLINICAL ANALYSIS TAB -->
                        <div id="{{prefix}}clinicalAnalysisEditor" class="variant-interpretation-content" style="display: none">
                            <!--<div id="{{prefix}}ClinicalAnalysisCreatorWarning" class="col-md-10 col-md-offset-2" style="padding: 20px 10px">-->
                            <!--<span class="alert alert-warning" role="alert" style="padding: 10px 10px;font-weight: bold;font-size: 1.2em">-->
                            <!--No valid Clinical Analysis found, please fill the form below to define one case. You can also save it.-->
                            <!--</span>-->
                            <!--</div>-->
                            <div style="padding: 10px 20px">
                                <opencga-clinical-analysis-creator opencga-session="{{opencgaSession}}"
                                                                   clinical-analysis="{{clinicalAnalysis}}"
                                                                   on-clinicalanalysischange="onClinicalAnalysisEditor"
                                                                   config="{{config.clinicalAnalysisBrowser}}">
                                </opencga-clinical-analysis-creator>
                            </div>
                        </div>

                        <!-- SAVE INTERPRETATION TAB -->
                        <div id="{{prefix}}InterpretationEditor" class="variant-interpretation-content" style="display: none">
                            <div style="padding: 10px 20px">
                                <opencga-variant-interpretation-editor opencga-session="{{opencgaSession}}"
                                                                       cellbase-client="{{cellbaseClient}}"
                                                                       clinical-analysis="{{clinicalAnalysis}}"
                                                                       reported-variants="{{checkedVariants}}"
                                                                       population-frequencies="{{populationFrequencies}}"
                                                                       protein-substitution-scores="{{proteinSubstitutionScores}}"
                                                                       consequence-types="{{consequenceTypes}}"
                                                                       on-gene="geneSelected" on-samplechange="onSampleChange"
                                                                       style="font-size: 12px" config="{{config}}">
                                </opencga-variant-interpretation-editor>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </template>

        <template is="dom-if" if="{{!checkProjects}}">
            <span style="text-align: center"><h3>No public projects available to browse. Please login to continue</h3></span>
        </template>

    </template>

    <script>
        class OpencgaVariantInterpretation extends Polymer.Element {

            constructor() {
                super();

                // Set status and init private properties
                this._init();
            }

            static get is() {
                return 'opencga-variant-interpretation';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object
                    },
                    clinicalAnalysisId: {
                        type: String,
                        value: "CA6",
                        observer: 'clinicalAnalysisIdObserver',
                    },
                    clinicalAnalysis: {
                        type: Object,
                        observer: 'clinicalAnalysisObserver',
                    },
                    query: {
                        type: Object
                    },
                    cellbaseClient: {
                        type: Object
                    },
                    diseasePanelId: {
                        type: String,
                        observer: "diseasePanelIdObserver"
                    },
                    consequenceTypes: {
                        type: Object
                    },
                    populationFrequencies: {
                        type: Object
                    },
                    proteinSubstitutionScores: {
                        type: Object
                    },
                    interactive: {
                        type: Boolean,
                        observer: "interactiveObserver"
                    },
                    config: {
                        type: Object
                    }
                }
            }

            static get observers() {
                /*
                 * We do not need to Observer 'query' property, when passed it will be shared (bound) with the other components.
                 * 'search; is observed to ensure 'query' is in sync.
                 */
                return [
                    "propertyObserver(opencgaSession, query, config)"
                ];
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            connectedCallback() {
                super.connectedCallback();

                if (!this.interactive) {
                    this.collapseFilter();
                }

                // CellBase version
                this.cellbaseClient.getMeta("about").then(response => {
                    if (UtilsNew.isNotUndefinedOrNull(response) && UtilsNew.isNotEmptyArray(response.response)) {
                        if (UtilsNew.isNotUndefinedOrNull(response.response[0].result) && UtilsNew.isNotEmptyArray(response.response[0].result)) {
                            this.cellbaseVersion = response.response[0].result[0]["Version: "];
                        }
                    }
                });
            }

            _init() {
                this.prefix = "ovi-" + Utils.randomString(6);

                this.hasClinicalAnalysis = false;

                this.checkProjects = false;
                this.interactive = true;
                this.filterClass = "col-md-2";
                this.gridClass = "col-md-10";

                this._collapsed = true;

                this.messageError = false;
                this.messageSuccess = false;

                this.samples = [];

                this.defaultAutomaticQuery = {
                    biotype: "protein_coding"
                };

                this.variant = null;
                this.reportedVariants = [];

                this._config = this.getDefaultConfig();
            }

            propertyObserver(opencgaSession, query, config) {
                // With each property change we must updated config and create the columns again. No extra checks are needed.
                this._config = Object.assign(this.getDefaultConfig(), this.config);

                // Check if Beacon hosts are configured
                for (let detail of this._config.detail) {
                    if (detail.id === "beacon" && UtilsNew.isNotEmptyArray(detail.hosts)) {
                        this.beaconConfig = {
                            hosts: detail.hosts
                        };
                    }
                }

                // Query passed is executed and set to variant-filter, active-filters and variant-grid components
                if (UtilsNew.isNotUndefinedOrNull(query)) {
                    this.preparedQuery = query;
                    this.executedQuery = query;
                }

                if (UtilsNew.isNotUndefinedOrNull(this.opencgaSession) && UtilsNew.isNotUndefinedOrNull(this.opencgaSession.project)) {
                    this.checkProjects = true;
                } else {
                    this.checkProjects = false;
                }
            }


            clinicalAnalysisIdObserver() {
                let _this = this;
                this.opencgaSession.opencgaClient.clinical().info(this.clinicalAnalysisId, {study: this.opencgaSession.study.fqn})
                    .then((response) => {
                        // This triggers the call to clinicalAnalysisObserver function below
                        _this.clinicalAnalysis = response.response[0].result[0];
                    })
                    .catch((response) => {
                        console.error("An error occurred fetching clinicalAnalysis: ", response)
                    });
            }

            clinicalAnalysisObserver() {
                if (UtilsNew.isNotUndefinedOrNull(this.clinicalAnalysis)) {
                    let _samples = [];
                    let _individuals = [];

                    if (UtilsNew.isNotUndefinedOrNull(this.clinicalAnalysis.family) && UtilsNew.isNotEmptyArray(this.clinicalAnalysis.family.members)) {
                        // this.set("family", this.clinicalAnalysis.family);
                        _individuals = this.clinicalAnalysis.family.members;
                    } else {
                        if (UtilsNew.isNotUndefinedOrNull(this.clinicalAnalysis.proband)) {
                            _individuals = [this.clinicalAnalysis.proband];
                        }
                    }

                    if (UtilsNew.isNotEmptyArray(_individuals)) {
                        _individuals.forEach(individual => {
                            if (UtilsNew.isNotUndefinedOrNull(individual.samples)) {
                                individual.samples.map(sample => {
                                    _samples.push(sample)
                                });
                            }
                        });
                    } else {
                        console.warn("A Clinical Analysis with no proband or family has been passed");
                    }

                    if (UtilsNew.isNotEmptyArray(_samples)) {
                        // Set samples array and notify, this must be done using Polymer API
                        // this.samples = Object.assign({}, _samples);

                        // We need a different private property for variant-browser-filter to avoid circular calls
                        // this._initGenotypeSamples(_samples);
                        this.search = Object.assign({}, this.query);
                        // debugger

                        // this.set("samplesForMenuFilter", _samples);

                        // Notify to all listeners of the new samples
                        this.dispatchEvent(new CustomEvent('samplechange', {detail: {samples: this.samples}}));
                    }

                    this.hasClinicalAnalysis = true;
                }
            }

            onClinicalAnalysisEditor(e) {
                // debugger
                this.clinicalAnalysis = Object.assign({}, e.detail.clinicalAnalysis);
            }

            diseasePanelIdObserver() {
                if (this.diseasePanelId !== undefined && PANELS !== undefined) {
                    for (let panel of PANELS) {
                        if (panel.id === this.diseasePanelId) {
                            this.diseasePanel = panel;
                            // TODO in theory we should do:
                            // this.defaultAutomaticQuery.panel = this.diseasePanelId;
                            this.defaultAutomaticQuery.gene = this.diseasePanel.genes.join(",");
                            break;
                        }
                    }
                }
            }

            interactiveObserver() {
                if (!this.interactive) {
                    this.collapseFilter();
                } else {
                    this.unCollapseFilter();
                }
            }

            onCollapse() {
                if (this._collapsed) {
                    this.unCollapseFilter();
                } else {
                    this.collapseFilter();
                }
            }

            collapseFilter() {
                this.filterClass = "hidden";
                this.gridClass = "prioritization-center";
                this._collapsed = true;
            }

            unCollapseFilter() {
                if (this.interactive) {
                    this.filterClass = "col-md-2";
                    this.gridClass = "col-md-10";
                    this._collapsed = false;
                }
            }


            /*
             * Variant Filter component listeners
             */
            onQueryFilterChange(e) {
                this.preparedQuery = e.detail.query;
            }

            onQueryFilterSearch(e) {
                this.preparedQuery = e.detail.query;
                this.executedQuery = e.detail.query;
            }

            /*
             * Active Filters component listeners
             */
            onActiveFilterChange(e) {
                this.query = e.detail;
            }

            onClear() {
                let _search = {};
                for (let hiddenField of this._config.activeFilters.hiddenFields) {
                    if (UtilsNew.isNotUndefinedOrNull(this.query[hiddenField])) {
                        _search[hiddenField] = this.query[hiddenField];
                    }
                }

                // this.search = _search;
                this.query = {
                    study: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias
                };
            }


            onActiveFilterChange(e) {
                // this.query = e.detail;
                // this.search = this.query;
                this.query = e.detail;
                // debugger
                this.search = e.detail;
            }

            _changeBottomTab(e) {
                let _activeTabs = {}
                for (let detail of this.config.detail) {
                    _activeTabs[detail.id] = (detail.id === e.currentTarget.dataset.id);
                }
                this.set("detailActiveTabs", _activeTabs);
            }

            checkVariant(variant) {
                return variant.split(':').length > 2;
            }

            onSelectVariant(e) {
                this.variant = e.detail.variant;
                // this.variant = e.detail.id;
                // this.variantObj = e.detail.variant;
            }

            onSelectVariant2(e) {
                debugger
                this.selectedVariant = e.detail.variant;
                // this.variant = e.detail.id;
                // this.variantObj = e.detail.variant;
            }

            onCheckVariant(e) {
                // Alexis: we need to do something like this:
                this.checkedVariants = e.detail.variants;

                // We set/remove disable status to Save button
                // if (this.checkedVariants.length > 0 && UtilsNew.isNotEmptyArray(this.samples)) {
                //     PolymerUtils.removeAttribute(this.prefix + 'SaveInterpretationButton', 'disabled');
                // } else {
                //     PolymerUtils.setAttribute(this.prefix + 'SaveInterpretationButton', 'disabled', true);
                // }
            }

            onSampleChange(e) {
                let _samples = e.detail.samples;
                this.set('samples', _samples.slice());
                this.dispatchEvent(new CustomEvent("samplechange", {detail: e.detail, bubbles: true, composed: true}));
                // this._initGenotypeSamples(this.samples);
            }

            onGenomeBrowserPositionChange(e) {
                $('.variant-interpretation-content').hide(); // hides all content divs
                $("#" + this.prefix + "GenomeBrowser").show(); // get the href and use it find which div to show

                // Show the active button
                $('.variant-interpretation-view-buttons').removeClass("active");
                // $(e.target).addClass("active");
                PolymerUtils.addClass(this.prefix + "GenomeBrowserButton", "active");

                this._genomeBrowserActive = true;

                this.region = e.detail.genomeBrowserPosition;
            }

            _initGenotypeSamples(samples, force, value) {
                if (UtilsNew.isUndefinedOrNull(this.genotypeSamples)) {
                    this.genotypeSamples = {};
                }
                let genotypeSamples = {};
                samples.forEach((sample) => {
                    if (UtilsNew.isUndefinedOrNull(genotypeSamples[sample.id]) || force){
                        genotypeSamples[sample.id] = {};
                        // this.genotypeSamples[sample.name]["0/0"] = UtilsNew.isNotUndefinedOrNull(value)? value : true;
                        genotypeSamples[sample.id]["0/1"] = UtilsNew.isNotUndefinedOrNull(value)? value : true;
                        genotypeSamples[sample.id]["1/1"] = UtilsNew.isNotUndefinedOrNull(value)? value : true;
                        // this.genotypeSamples[sample.name]["./."] = UtilsNew.isNotUndefinedOrNull(value)? value : true;
                    }
                });
                debugger
                this.query = Object.assign({}, this.query, {genotype: this.getGenotypeFilter(genotypeSamples)});
                debugger
            }

            getGenotypeFilter(genotypeSamples) {
                let genotype = [];
                Object.keys(genotypeSamples).forEach(sampleId => {
                    if (UtilsNew.isNotUndefinedOrNull(genotypeSamples[sampleId])) {
                        // genotype += sampleId+ ":";
                        let gt = [];
                        if (genotypeSamples[sampleId]["0/0"]) {
                            gt.push("0/0");
                        }
                        if (genotypeSamples[sampleId]["0/1"]) {
                            gt.push("0/1");
                        }
                        if (genotypeSamples[sampleId]["1/1"]) {
                            gt.push("1/1");
                        }
                        if (genotypeSamples[sampleId]["./."]) {
                            gt.push("./.");
                        }
                        genotype.push(sampleId+ ":" + gt.join(","));
                    }
                });
                return genotype.join(";");
            }

            _changeView(e) {
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed

                PolymerUtils.hideByClass("variant-interpretation-content");

                if (typeof e.target !== "undefined" && typeof e.target.dataset.view !== "undefined") {
                    PolymerUtils.show(this.prefix + e.target.dataset.view); // get the href and use it find which div to show
                }

                // Show the active button
                PolymerUtils.removeClass(".variant-interpretation-view-buttons", "active");
                // debugger
                $(e.target).addClass("active");

                // Make Genome Browser active
                this._genomeBrowserActive = (e.target.dataset.view === "GenomeBrowser");
            }

            _backToSelectAnalysis(e) {
                this.dispatchEvent(new CustomEvent('backtoselectanalysis', {detail: {idTab: "PrioritizationButton"}}));
            }

            _goToReport(e) {
                this.dispatchEvent(new CustomEvent('gotoreport', {detail: {interpretation: this.interpretation}}));
            }

            triggerBeacon(e) {
                this.variantToBeacon = this.variant.id;
            }

            onViewInterpretation(e) {
                this.interpretationView = this._createInterpretation();
            }

            onSaveInterpretation(e, obj) {
                let id = PolymerUtils.getValue(this.prefix + "IDInterpretation");
                let description = PolymerUtils.getValue(this.prefix + "DescriptionInterpretation");
                let comment = PolymerUtils.getValue(this.prefix + "CommentInterpretation");

                if (UtilsNew.isNotEmpty(id)) {
                    if (/\s/.test(id)) {
                        this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                            detail: {
                                message: "ID must not contains blanks.",
                                type: UtilsNew.MESSAGE_ERROR
                            },
                            bubbles: true,
                            composed: true
                        }));
                    } else {
                        this.interpretation = this._createInterpretation();
                    }
                } else {
                    this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                        detail: {
                            message: "ID must not be empty.",
                            type: UtilsNew.MESSAGE_ERROR
                        },
                        bubbles: true,
                        composed: true
                    }));
                }
            }

            _createInterpretation() {
                try {
                    let userID = this.opencgaSession.opencgaClient._config.userId;
                    let interpretation = {};
                    interpretation.id = this.clinicalAnalysis.id + "_" + PolymerUtils.getValue(this.prefix + "IDInterpretation");
                    // interpretation.name = PolymerUtils.getValue(this.prefix + "NameInterpretation");
                    interpretation.description = PolymerUtils.getValue(this.prefix + "DescriptionInterpretation");
                    interpretation.clinicalAnalysisId = this.clinicalAnalysisId;
                    interpretation.software = {
                        name: "TEAM",
                        version: "2.0",
                        website: "https://www.ncbi.nlm.nih.gov/pubmed/24861626",
                        repository: "https://github.com/opencb/opencga",
                        commit: "f43372aa",
                        params: {}
                    };
                    interpretation.analyst = {
                        name: userID,
                        email: "",
                        company: ""
                    };
                    interpretation.dependencies = [
                        {
                            name: "CellBase", repository: "https://github.com/opencb/cellbase", version: this.cellbaseVersion
                        }
                    ];
                    interpretation.filters = this.query;
                    //                interpretation.creationDate = Date();
                    interpretation.comments = [{
                        author: userID,
                        type: "comment",
                        text: PolymerUtils.getValue(this.prefix + "CommentInterpretation"),
                        date: moment(new Date(), "YYYYMMDDHHmmss").format('D MMM YY')
                    }];

                    // Remove 'stateCheckbox' from the variant list. When we receive the list from the grid, we are getting
                    // an additional field that should not be present in a reported variant.
                    let reportedVariants = [];
                    for (let i in this.checkedVariants) {
                        let variant = Object.assign({}, this.checkedVariants[i]);
                        delete variant['stateCheckBox'];
                        reportedVariants.push(variant);
                    }
                    interpretation.reportedVariants = reportedVariants;
                    interpretation.attributes = {};
                    // interpretation.creationDate = moment(new Date(), "YYYYMMDDHHmmss").format('D MMM YY');


                    let params = {
                        study: this.opencgaSession.study.fqn
                    };

                    let _this = this;
                    this.opencgaSession.opencgaClient.interpretations().create(this.clinicalAnalysis.id, params, interpretation)
                        .then((response) => {
                            console.log(response);
                            // TODO We should update here clinicalAnalysis and add to interpretation list this file with its name from save interpertation form.
                            if (UtilsNew.isNotUndefinedOrNull(interpretation) && UtilsNew.isNotUndefinedOrNull(interpretation.clinicalAnalysis)) {
                                if (UtilsNew.isEmptyArray(interpretation.clinicalAnalysis.interpretations)) {
                                    interpretation.clinicalAnalysis.interpretations = [];
                                } else {
                                    interpretation.clinicalAnalysis.interpretations = interpretation.clinicalAnalysis.interpretations.map((interpretation) => {
                                        return { id: interpretation.id, name: interpretation.name, file:  interpretation.file.id };
                                    });
                                }
                                interpretation.clinicalAnalysis.interpretations.push({
                                    id: interpretation.id,
                                    name: interpretation.name,
                                    file: response.response[0].result[0].id
                                });
                            }

                            params = {
                                study: _this.opencgaSession.project.alias + ":" + _this.opencgaSession.study.alias
                            };
                            let interpretations =  { interpretations: interpretation.clinicalAnalysis.interpretations };
                            _this.opencgaSession.opencgaClient.clinical().update(interpretation.clinicalAnalysis.id, params, interpretations)
                                .then((response) => {
                                    this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                                        detail: {
                                            message:  interpretation.id + " interpretation has been created correctly.",
                                            type: UtilsNew.MESSAGE_SUCCESS
                                        },
                                        bubbles: true,
                                        composed: true
                                    }));

                                    _this.cleanSaveInterpretation();
                                    console.log(response);
                                    // Update analysis with new interpretations
                                    _this.getAnalysisInterpretations();
                                })
                                .catch((err) => {
                                    this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                                        detail: {
                                            message:  err.error,
                                            type: UtilsNew.MESSAGE_ERROR
                                        },
                                        bubbles: true,
                                        composed: true
                                    }));
                                });
                        })
                        .catch((err) => {
                            this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                                detail: {
                                    message:  err.error,
                                    type: UtilsNew.MESSAGE_ERROR
                                },
                                bubbles: true,
                                composed: true
                            }));
                        });

                } catch (err) {
                    this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                        detail: {
                            message:  err,
                            type: UtilsNew.MESSAGE_ERROR
                        },
                        bubbles: true,
                        composed: true
                    }));
                }
            }

            cleanSaveInterpretation() {
                PolymerUtils.setValue(this.prefix + "IDInterpretation", "");
                PolymerUtils.setValue(this.prefix + "NameInterpretation", "");
                PolymerUtils.setValue(this.prefix + "DescriptionInterpretation", "");
                PolymerUtils.setValue(this.prefix + "CommentInterpretation", "");
            }

            getAnalysisInterpretations() {
                let params = {
                    study: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias
                };
                let _this = this;
                this.opencgaSession.opencgaClient.clinical().info(this.clinicalAnalysis.id, params, {})
                    .then(function(response){
                        _this.showSummary = false;
                        if (response.response[0].numResults === 1) {
                            _this.clinicalAnalysis = response.response[0].result[0];
                        }
                    });
            }

            getDefaultConfig() {
                return {
                    activeFilters: {
                        alias: {
                            // Example:
                            // "region": "Region",
                            // "gene": "Gene",
                            // "genotype": "Sample Genotypes",
                        },
                        complexFields: ["genotype"],
                        hiddenFields: ["study"]
                    },
                    genomeBrowser: {
                        showTitle: false
                    }
                }
            }
        }

        customElements.define(OpencgaVariantInterpretation.is, OpencgaVariantInterpretation);
    </script>
</dom-module>
