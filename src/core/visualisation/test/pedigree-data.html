<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!DOCTYPE html>

<html lang="en">
<head>

    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- This is configured below in the onLoad() function -->
    <title></title>
</head>

<body>
<script type="module">
    import family from "./resources/101761.js";

    let individualsPool = JSON.parse(JSON.stringify(family));
    console.log(family)

    function getNode(id) {
        return family.find( i => i.id === id)
    }

    function getParents(node) {
        return node.father.id && node.mother.id ? [node.father.id, node.mother.id] : null
    }
    function getChildren(node) {
        const role = node.sex === "MALE"? "father" : "mother";
        return family.filter( i => i[role].id === node.id)
    }

    function getSpouse(node) {
        const children = getChildren(node);
        const spouseRole = node.sex === "MALE"? "mother" : "father";
        const spouses = [...new Set(children.map( i => i[spouseRole].id))]
        if (spouses.length > 1) console.error("More than 1 spouse");
        return getNode(spouses[0]);
    }

    /*function getLevel(id) {
        for (let row = 0; x < DATA.length; row++ ) {
            for (let col = 0; col < row.length; col++ ) {
                if (id === DATA[row][col]) return row;
            }
        } console.error("node level not found");
    }*/


    function hasParentInPool(node, array) {
        const [father, mother] = [array.find( i => i.id === node.father.id), array.find( i => i.id === node.mother.id)];
        return father && mother;
    }

    function removeNodes(ids, array) {
        return array.filter( el => !ids.includes(el.id));
    }

    let generations = []; //init root level
    let generationCnt = 0;
    while (individualsPool.length) {
        let generationNodes = [];
        for (let i = 0; i < individualsPool.length; i++ ){
            const node = individualsPool[i];
            const spouse = getSpouse(node); //NOTE getSpouse() search in the original family, not in the pool
            if (!hasParentInPool(node, individualsPool) && (!spouse || (spouse && !hasParentInPool(spouse, individualsPool)))) {
                generationNodes.push({
                    ...node,
                    children: getChildren(node)
                });
            }
        }
        generations[generationCnt] = {
            id: generationCnt,
            individuals: generationNodes
        };
        generationCnt++;
        individualsPool = removeNodes(generationNodes.map(_ => _.id), individualsPool);
    }

    console.log(generations)

</script>


</body>
</html>
